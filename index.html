<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (‡∏™‡∏ô‡∏ç.) - Enterprise</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: { 
                extend: { 
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] }, 
                    colors: { brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' } },
                    animation: { 'scale-in': 'scaleIn 0.2s ease-out' },
                    keyframes: { scaleIn: { '0%': { transform: 'scale(0.9)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } } }
                } 
            }
        }
    </script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .table-hover tr:hover { background-color: #f8fafc; }
        canvas { touch-action: none; } /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
    </style>
</head>
<body>

    <div id="app" class="h-screen w-full flex flex-col overflow-hidden text-slate-800">

        <div v-if="isLoading" class="fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center text-white flex-col backdrop-blur-sm">
            <i class="fas fa-circle-notch fa-spin text-5xl mb-4 text-brand-500"></i>
            <p class="text-xl font-light tracking-wider animate-pulse">{{ loadingText }}</p>
        </div>

        <div v-if="!user" class="flex-1 flex items-center justify-center bg-brand-900 bg-opacity-95 p-4" 
             style="background-image: url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?auto=format'); background-size: cover; background-blend-mode: multiply;">
            
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 transition-all">
                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-brand-50 text-brand-600 mb-4 shadow-sm">
                        <i class="fas fa-layer-group text-3xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏á‡∏ö (‡∏™‡∏ô‡∏ç.)</h1>
                    <p class="text-gray-500 text-sm">Central Budget Approval System</p>
                </div>

                <div class="flex bg-gray-100 p-1 rounded-lg mb-6">
                    <button @click="authMode='login'" :class="authMode==='login'?'bg-white shadow text-brand-600':''" class="flex-1 py-2 rounded-md font-bold text-sm transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <button @click="authMode='register'" :class="authMode==='register'?'bg-white shadow text-brand-600':''" class="flex-1 py-2 rounded-md font-bold text-sm transition">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà</button>
                </div>

                <form v-if="authMode === 'login'" @submit.prevent="handleLogin" class="space-y-4">
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-gray-500 uppercase">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                        <input v-model="loginForm.email" type="email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none transition">
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-gray-500 uppercase">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                        <input v-model="loginForm.password" type="password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none transition">
                    </div>
                    <button type="submit" class="w-full bg-brand-600 text-white py-3 rounded-lg font-bold hover:bg-brand-700 shadow-lg transform active:scale-95 transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                </form>

                <form v-else @submit.prevent="handleRegister" class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <input v-model="regForm.firstname" placeholder="‡∏ä‡∏∑‡πà‡∏≠" required class="px-4 py-2 border rounded-lg text-sm">
                        <input v-model="regForm.lastname" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required class="px-4 py-2 border rounded-lg text-sm">
                    </div>
                    <input v-model="regForm.email" type="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£" required class="w-full px-4 py-2 border rounded-lg text-sm">
                    <input v-model="regForm.password" type="password" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required class="w-full px-4 py-2 border rounded-lg text-sm">
                    <div class="grid grid-cols-2 gap-3">
                        <select v-model="regForm.zone" required class="px-4 py-2 border rounded-lg text-sm bg-white">
                            <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô</option>
                            <option v-for="n in 15" :key="n" :value="n">Zone {{ n }}</option>
                        </select>
                        <input v-model="regForm.branch" placeholder="‡∏™‡∏≤‡∏Ç‡∏≤" required class="px-4 py-2 border rounded-lg text-sm">
                    </div>
                    <input v-model="regForm.department" placeholder="‡∏ù‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î" required class="w-full px-4 py-2 border rounded-lg text-sm">
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700 shadow transition">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                </form>
            </div>
        </div>

        <div v-else class="flex flex-1 overflow-hidden">
            
            <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col shadow-xl z-20 hidden md:flex">
                <div class="p-6 border-b border-slate-700">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-brand-400 to-brand-600 flex items-center justify-center text-white font-bold text-lg shadow-lg">
                            {{ user.name.charAt(0) }}
                        </div>
                        <div class="overflow-hidden">
                            <h2 class="font-bold text-white truncate w-32">{{ user.name }}</h2>
                            <p class="text-xs text-brand-400 font-mono">{{ user.role }}</p>
                        </div>
                    </div>
                </div>

                <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                    <a @click="navigate('dashboard')" :class="navClass('dashboard')" class="nav-item">
                        <i class="fas fa-home w-6"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
                    </a>

                    <div v-if="user.role === 'USER'" class="mt-4">
                        <p class="text-xs font-bold text-slate-500 uppercase px-3 mb-2">‡πÄ‡∏°‡∏ô‡∏π‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</p>
                        <a @click="navigate('create_request')" :class="navClass('create_request')" class="nav-item">
                            <i class="fas fa-plus-circle w-6"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà
                        </a>
                    </div>

                    <div v-if="user.role === 'ADMIN'" class="mt-4">
                        <p class="text-xs font-bold text-slate-500 uppercase px-3 mb-2">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
                        <a @click="navigate('users')" :class="navClass('users')" class="nav-item">
                            <i class="fas fa-users-cog w-6"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£
                            <span v-if="stats.pendingUserCount > 0" class="ml-auto bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">{{ stats.pendingUserCount }}</span>
                        </a>
                        <a @click="navigate('requests')" :class="navClass('requests')" class="nav-item">
                            <i class="fas fa-file-invoice-dollar w-6"></i> ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏ö
                            <span v-if="stats.pendingReqCount > 0" class="ml-auto bg-orange-500 text-white text-xs px-2 py-0.5 rounded-full">{{ stats.pendingReqCount }}</span>
                        </a>
                        <a @click="navigate('logs')" :class="navClass('logs')" class="nav-item">
                            <i class="fas fa-shield-alt w-6"></i> Audit Logs
                        </a>
                        <a @click="navigate('export')" :class="navClass('export')" class="nav-item">
                            <i class="fas fa-file-export w-6"></i> Export Data
                        </a>
                    </div>
                </nav>

                <div class="p-4 bg-slate-800 border-t border-slate-700">
                    <button @click="logout" class="w-full flex items-center gap-2 text-red-400 hover:text-red-300 transition px-2 py-1 rounded hover:bg-slate-700">
                        <i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </aside>

            <main class="flex-1 flex flex-col bg-slate-50 overflow-hidden relative">
                
                <header class="bg-white shadow-sm px-6 py-4 flex justify-between items-center z-10 md:hidden">
                    <span class="font-bold text-brand-900">‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</span>
                    <button @click="logout" class="text-red-500"><i class="fas fa-sign-out-alt"></i></button>
                </header>

                <div class="flex-1 overflow-auto p-4 md:p-8">
                    
                    <div v-if="currentView === 'dashboard'">
                        <div class="flex justify-between items-end mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">Dashboard</h2>
                                <p class="text-gray-500">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, {{ user.name }} ({{ user.department }})</p>
                            </div>
                            <button @click="refreshData" class="text-brand-600 hover:text-brand-800 text-sm bg-white px-3 py-1 rounded shadow-sm hover:shadow">
                                <i class="fas fa-sync-alt mr-1"></i> Refresh
                            </button>
                        </div>

                        <div v-if="user.role === 'ADMIN'" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-blue-500">
                                <p class="text-gray-500 text-xs uppercase font-bold">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                                <p class="text-3xl font-bold text-gray-800 mt-1">{{ stats.totalUsers }}</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-orange-500">
                                <p class="text-gray-500 text-xs uppercase font-bold">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏á‡∏ö</p>
                                <p class="text-3xl font-bold text-gray-800 mt-1">{{ stats.pendingReqCount }}</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-green-500">
                                <p class="text-gray-500 text-xs uppercase font-bold">‡∏á‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</p>
                                <p class="text-2xl font-bold text-green-600 mt-1">{{ formatCurrency(stats.usedBudget) }}</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-purple-500">
                                <p class="text-gray-500 text-xs uppercase font-bold">‡πÇ‡∏ã‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</p>
                                <p class="text-3xl font-bold text-gray-800 mt-1">Zone {{ stats.maxZone }}</p>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                            <div class="px-6 py-4 border-b flex justify-between items-center bg-gray-50">
                                <h3 class="font-bold text-gray-700">{{ user.role === 'ADMIN' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î' : '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô' }}</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-gray-100 text-gray-500 uppercase font-bold text-xs">
                                        <tr>
                                            <th class="px-6 py-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / ID</th>
                                            <th class="px-6 py-3">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
                                            <th class="px-6 py-3 text-right">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
                                            <th class="px-6 py-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                            <th class="px-6 py-3 text-center">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
                                            <th v-if="user.role==='ADMIN'" class="px-6 py-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y">
                                        <tr v-for="req in (user.role==='ADMIN' ? allRequests.slice(0,10) : myRequests)" :key="req.id" class="table-hover transition">
                                            <td class="px-6 py-3">
                                                <div class="font-bold text-brand-700">{{ req.id }}</div>
                                                <div class="text-xs text-gray-400">{{ formatDate(req.timestamp) }}</div>
                                            </td>
                                            <td class="px-6 py-3">
                                                <div class="font-medium">{{ req.title }}</div>
                                                <div v-if="user.role==='ADMIN'" class="text-xs text-gray-500">{{ req.requester }} (Z{{ req.zone }})</div>
                                            </td>
                                            <td class="px-6 py-3 text-right font-mono">{{ formatCurrency(req.amount) }}</td>
                                            <td class="px-6 py-3 text-center"><span :class="statusBadge(req.status)">{{ req.status }}</span></td>
                                            <td class="px-6 py-3 text-center">
                                                <button v-if="req.fileId" @click="viewFile(req.fileId)" class="text-blue-500 hover:text-blue-700 text-xs font-bold border border-blue-200 px-2 py-1 rounded bg-blue-50">
                                                    <i class="fas fa-search"></i> ‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå
                                                </button>
                                                <span v-else class="text-xs text-gray-300">-</span>
                                            </td>
                                            <td v-if="user.role==='ADMIN'" class="px-6 py-3 text-center">
                                                <button @click="openRequestDetail(req)" class="text-gray-400 hover:text-brand-600"><i class="fas fa-edit"></i></button>
                                            </td>
                                        </tr>
                                        <tr v-if="(user.role==='ADMIN' ? allRequests : myRequests).length === 0">
                                            <td colspan="6" class="p-8 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div v-if="currentView === 'create_request'" class="max-w-2xl mx-auto">
                        <div class="mb-6 flex items-center gap-2">
                            <button @click="navigate('dashboard')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-arrow-left"></i></button>
                            <h2 class="text-2xl font-bold text-gray-800">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h2>
                        </div>
                        
                        <form @submit.prevent="submitRequest" class="bg-white p-8 rounded-xl shadow-lg space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="col-span-2">
                                    <label class="block text-sm font-bold text-gray-700 mb-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>
                                    <input v-model="requestForm.title" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand-500 outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (‡∏ö‡∏≤‡∏ó)</label>
                                    <input v-model="requestForm.amount" type="number" min="1" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand-500 outline-none font-mono">
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-sm font-bold text-gray-700 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î / ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô</label>
                                    <textarea v-model="requestForm.description" rows="4" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand-500 outline-none"></textarea>
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-sm font-bold text-gray-700 mb-1">‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (PDF/‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)</label>
                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center bg-gray-50 hover:bg-gray-100 transition">
                                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                        <p class="text-sm text-gray-500">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</p>
                                        <input type="file" @change="handleFileUpload" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100 mt-4 mx-auto max-w-xs">
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-brand-600 text-white py-3 rounded-lg font-bold hover:bg-brand-700 shadow-lg transition transform active:scale-95">
                                <i class="fas fa-paper-plane mr-2"></i> ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                            </button>
                        </form>
                    </div>

                    <div v-if="currentView === 'requests'" class="space-y-4">
                        <div class="bg-white p-4 rounded-xl shadow-sm flex flex-wrap gap-4 items-center">
                            <span class="font-bold text-gray-600"><i class="fas fa-filter"></i> ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á:</span>
                            <select v-model="filters.zone" class="border rounded px-3 py-2 text-sm"><option value="">‡∏ó‡∏∏‡∏Å‡πÇ‡∏ã‡∏ô</option><option v-for="n in 15" :value="n">Zone {{ n }}</option></select>
                            <select v-model="filters.status" class="border rounded px-3 py-2 text-sm"><option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option><option value="PENDING_HQ">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option><option value="APPROVED">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</option></select>
                            <input v-model="filters.search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="border rounded px-3 py-2 text-sm w-48">
                        </div>
                        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100 text-gray-500 uppercase text-xs"><tr><th class="p-4">ID</th><th class="p-4">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th><th class="p-4">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th><th class="p-4 text-right">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th><th class="p-4 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="p-4 text-center">Action</th></tr></thead>
                                <tbody class="divide-y">
                                    <tr v-for="req in filteredRequests" :key="req.id" class="table-hover cursor-pointer" @click="openRequestDetail(req)">
                                        <td class="p-4 font-bold text-brand-600">{{ req.id }}</td>
                                        <td class="p-4">{{ req.title }}</td>
                                        <td class="p-4">{{ req.requester }} (Z{{ req.zone }})</td>
                                        <td class="p-4 text-right font-mono">{{ formatCurrency(req.amount) }}</td>
                                        <td class="p-4 text-center"><span :class="statusBadge(req.status)">{{ req.status }}</span></td>
                                        <td class="p-4 text-center text-gray-400"><i class="fas fa-chevron-right"></i></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div v-if="currentView === 'users'" class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="font-bold text-lg mb-4">‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</h3>
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100 text-gray-500 uppercase text-xs"><tr><th class="p-3">‡∏ä‡∏∑‡πà‡∏≠</th><th class="p-3">‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</th><th class="p-3">Role</th><th class="p-3">Limit</th><th class="p-3 text-right">Action</th></tr></thead>
                            <tbody class="divide-y">
                                <tr v-for="u in pendingUsers" :key="u.email">
                                    <td class="p-3 font-bold">{{ u.name }}<br><span class="text-xs text-gray-400 font-normal">{{ u.email }}</span></td>
                                    <td class="p-3">{{ u.department }} (Z{{ u.zone }})</td>
                                    <td class="p-3"><select v-model="u.tempRole" class="border rounded text-xs p-1"><option value="USER">User</option><option value="ADMIN">Admin</option></select></td>
                                    <td class="p-3"><input type="number" v-model="u.tempLimit" class="border rounded text-xs p-1 w-20" placeholder="0"></td>
                                    <td class="p-3 text-right"><button @click="approveUser(u)" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-green-700">Approve</button></td>
                                </tr>
                                <tr v-if="pendingUsers.length === 0"><td colspan="5" class="p-6 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div v-if="currentView === 'logs'" class="bg-slate-900 text-green-400 p-6 rounded-xl shadow-lg font-mono text-xs h-full overflow-auto">
                        <p class="border-b border-gray-700 pb-2 mb-2">>> SYSTEM AUDIT TRAIL</p>
                        <p class="text-gray-500">... (Logs are recorded in backend Sheet "Logs") ...</p>
                        <button @click="downloadCSV('logs')" class="mt-4 bg-gray-700 text-white px-3 py-1 rounded hover:bg-gray-600">Download Full Logs (.csv)</button>
                    </div>
                    <div v-if="currentView === 'export'" class="flex gap-4">
                        <button @click="downloadCSV('users')" class="flex-1 bg-blue-50 text-blue-600 p-8 rounded-xl border border-blue-200 hover:bg-blue-100 font-bold"><i class="fas fa-users text-2xl mb-2 block"></i> Export Users</button>
                        <button @click="downloadCSV('requests')" class="flex-1 bg-green-50 text-green-600 p-8 rounded-xl border border-green-200 hover:bg-green-100 font-bold"><i class="fas fa-file-invoice text-2xl mb-2 block"></i> Export Requests</button>
                    </div>

                </div>

                <div v-if="previewUrl" class="fixed inset-0 bg-black bg-opacity-90 z-[150] flex items-center justify-center p-4" @click.self="closePreview">
                    <div class="bg-white w-full max-w-5xl h-[90vh] rounded-xl flex flex-col animate-scale-in overflow-hidden">
                        <div class="flex justify-between items-center p-3 border-b bg-gray-50">
                            <h3 class="font-bold text-gray-700"><i class="fas fa-eye mr-2"></i> ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h3>
                            <button @click="closePreview" class="text-gray-400 hover:text-red-500 text-xl"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="flex-1 bg-gray-200 relative">
                            <iframe :src="previewUrl" class="w-full h-full border-0" allow="autoplay"></iframe>
                        </div>
                        <div class="p-3 border-t bg-gray-50 text-right">
                            <a :href="previewUrl" target="_blank" class="text-brand-600 text-sm hover:underline mr-4">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà <i class="fas fa-external-link-alt"></i></a>
                        </div>
                    </div>
                </div>

                <div v-if="selectedRequest" class="fixed inset-0 bg-black bg-opacity-60 z-[120] flex justify-end">
                    <div class="bg-white w-full max-w-2xl h-full shadow-2xl flex flex-col animate-scale-in p-0">
                        <div class="p-6 border-b flex justify-between items-start bg-gray-50">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">{{ selectedRequest.title }}</h2>
                                <p class="text-sm text-gray-500">{{ selectedRequest.id }} | {{ formatDate(selectedRequest.timestamp) }}</p>
                            </div>
                            <button @click="selectedRequest=null" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-2xl"></i></button>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto p-6 space-y-6">
                            <div class="grid grid-cols-2 gap-4 bg-blue-50 p-4 rounded-lg border border-blue-100">
                                <div><p class="text-xs text-blue-500 font-bold uppercase">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</p><p class="font-bold text-gray-800">{{ selectedRequest.requester }}</p></div>
                                <div class="text-right"><p class="text-xs text-blue-500 font-bold uppercase">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</p><p class="text-xl font-bold text-brand-600 font-mono">{{ formatCurrency(selectedRequest.amount) }}</p></div>
                                <div class="col-span-2 text-sm text-gray-600">{{ selectedRequest.department }} (Zone {{ selectedRequest.zone }})</div>
                            </div>

                            <div>
                                <h3 class="font-bold text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3>
                                <p class="text-gray-600 text-sm bg-gray-50 p-4 rounded-lg">{{ selectedRequest.description }}</p>
                            </div>

                            <div>
                                <h3 class="font-bold text-gray-700 mb-2">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</h3>
                                <button v-if="selectedRequest.fileId" @click="viewFile(selectedRequest.fileId)" class="flex items-center gap-2 px-4 py-2 border rounded-lg text-blue-600 bg-blue-50 hover:bg-blue-100 transition text-sm font-bold">
                                    <i class="fas fa-file-pdf"></i> ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö
                                </button>
                                <p v-else class="text-sm text-gray-400">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ -</p>
                            </div>

                            <div v-if="selectedRequest.status === 'PENDING_HQ' && user.role === 'ADMIN'" class="border-t pt-6">
                                <h3 class="font-bold text-gray-800 mb-4 border-l-4 border-brand-500 pl-2">‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>
                                <label class="block text-sm text-gray-600 mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (Note)</label>
                                <textarea v-model="actionNote" class="w-full border rounded-lg p-3 text-sm mb-4" rows="2"></textarea>
                                
                                <label class="block text-sm text-gray-600 mb-1">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ <span class="text-red-500">*</span></label>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg mb-2 relative">
                                    <canvas ref="sigPad" width="500" height="150" class="w-full h-32 cursor-crosshair bg-white rounded-lg"></canvas>
                                    <div class="absolute top-2 right-2 text-xs text-gray-400 pointer-events-none">‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
                                </div>
                                <button @click="clearSig" class="text-xs text-red-500 hover:underline mb-6">‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</button>

                                <div class="grid grid-cols-2 gap-4">
                                    <button @click="processRequest('REJECTED')" class="py-3 border border-red-200 text-red-600 font-bold rounded-lg hover:bg-red-50">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                    <button @click="processRequest('APPROVED')" class="py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 shadow-lg">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, nextTick } = Vue;

        // ============================================
        //  üî¥ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á Apps Script ‡∏Ñ‡∏∏‡∏ì
        // ============================================
        const API_URL = "https://script.google.com/macros/s/AKfycbzuGfNO9qO2XLBrZOUTeaNlGx3e9W2kwS2Uz5M7p_mprnwJNo1fHTBE3nVrxETTN8wx/exec"; 

        createApp({
            setup() {
                // State
                const isLoading = ref(false);
                const loadingText = ref('');
                const user = ref(null);
                const authMode = ref('login');
                const currentView = ref('dashboard');
                
                // Data
                const loginForm = ref({ email: '', password: '' });
                const regForm = ref({ firstname: '', lastname: '', email: '', password: '', zone: '', branch: '', department: '' });
                const requestForm = ref({ title: '', amount: '', description: '', file: null });
                
                const stats = ref({});
                const pendingUsers = ref([]);
                const allRequests = ref([]);
                const myRequests = ref([]);
                const filters = ref({ zone: '', status: '', search: '' });
                
                // Modal & Actions
                const selectedRequest = ref(null);
                const previewUrl = ref(null);
                const actionNote = ref('');
                const sigPad = ref(null);
                let ctx = null, isDrawing = false;

                // --- API HELPER ---
                const callApi = async (payload) => {
                    isLoading.value = true;
                    try {
                        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                        return await res.json();
                    } catch (e) {
                        Swal.fire('Connection Error', 'Check your internet connection', 'error');
                        return { status: 'error' };
                    } finally {
                        isLoading.value = false;
                    }
                };

                // --- FILE HELPERS ---
                const getBase64 = (file) => new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });

                const handleFileUpload = (event) => requestForm.value.file = event.target.files[0];

                const viewFile = (fileId) => {
                    if(!fileId) return Swal.fire('Info', 'No file attached', 'info');
                    // Google Drive Preview URL
                    previewUrl.value = `https://drive.google.com/file/d/${fileId}/preview`;
                };
                const closePreview = () => previewUrl.value = null;

                // --- AUTH ---
                const handleLogin = async () => {
                    loadingText.value = 'Authenticating...';
                    const res = await callApi({ action: 'login', ...loginForm.value });
                    if(res.status === 'success') {
                        user.value = res;
                        refreshData();
                    } else Swal.fire('Login Failed', res.message, 'error');
                };

                const handleRegister = async () => {
                    loadingText.value = 'Registering...';
                    const res = await callApi({ action: 'register', ...regForm.value });
                    if(res.status === 'success') {
                        Swal.fire('Success', res.message, 'success');
                        authMode.value = 'login';
                    } else Swal.fire('Error', res.message, 'error');
                };

                const logout = () => { user.value = null; loginForm.value = {email:'', password:''}; };

                // --- DATA FETCHING ---
                const refreshData = async () => {
                    if(user.value.role === 'ADMIN') {
                        const res = await callApi({ action: 'getAdminData' });
                        if(res.status === 'success') {
                            stats.value = res.data.stats;
                            pendingUsers.value = res.data.pendingUsers.map(u => ({...u, tempRole: 'USER', tempLimit: 0}));
                            allRequests.value = res.data.allRequests;
                        }
                    } else {
                        const res = await callApi({ action: 'getUserRequests', email: user.value.email });
                        if(res.status === 'success') myRequests.value = res.data;
                    }
                };

                // --- REQUEST ACTIONS ---
                const submitRequest = async () => {
                    loadingText.value = 'Uploading & Sending...';
                    let fileData = null, fileName = null;
                    if(requestForm.value.file) {
                        fileData = await getBase64(requestForm.value.file);
                        fileName = requestForm.value.file.name;
                    }
                    const payload = {
                        action: 'createRequest',
                        ...requestForm.value,
                        requesterName: user.value.name,
                        requesterEmail: user.value.email,
                        department: user.value.department,
                        zone: user.value.zone,
                        fileData, fileName
                    };
                    const res = await callApi(payload);
                    if(res.status === 'success') {
                        Swal.fire('Success', 'Sent successfully', 'success');
                        requestForm.value = { title:'', amount:'', description:'', file:null };
                        navigate('dashboard');
                    } else Swal.fire('Error', res.message, 'error');
                };

                const openRequestDetail = (req) => {
                    selectedRequest.value = req;
                    actionNote.value = '';
                    if(req.status === 'PENDING_HQ' && user.value.role === 'ADMIN') {
                        nextTick(initSigPad);
                    }
                };

                const processRequest = async (status) => {
                    if(status === 'APPROVED' && isCanvasBlank()) return Swal.fire('Alert', 'Please sign your name.', 'warning');
                    loadingText.value = 'Processing...';
                    const signature = sigPad.value ? sigPad.value.toDataURL() : '';
                    const res = await callApi({
                        action: 'processRequest',
                        reqId: selectedRequest.value.id,
                        status,
                        note: actionNote.value,
                        signature,
                        adminEmail: user.value.email
                    });
                    if(res.status === 'success') {
                        Swal.fire('Success', 'Processed successfully', 'success');
                        selectedRequest.value = null;
                        refreshData();
                    }
                };

                const approveUser = async (u) => {
                    loadingText.value = 'Approving...';
                    const res = await callApi({ action: 'approveUser', targetEmail: u.email, role: u.tempRole, limit: u.tempLimit, adminEmail: user.value.email });
                    if(res.status === 'success') {
                        Swal.fire('Success', 'User approved', 'success');
                        refreshData();
                    }
                };

                const downloadCSV = async (type) => {
                    loadingText.value = 'Generating CSV...';
                    const res = await callApi({ action: 'exportData', type, adminEmail: user.value.email });
                    if(res.status === 'success') {
                        let csv = "data:text/csv;charset=utf-8," + res.data.map(e => e.join(",")).join("\n");
                        let link = document.createElement("a");
                        link.href = encodeURI(csv);
                        link.download = `export_${type}.csv`;
                        link.click();
                        loadingText.value = '';
                    }
                };

                // --- SIGNATURE PAD ---
                const initSigPad = () => {
                    const canvas = sigPad.value;
                    if(!canvas) return;
                    ctx = canvas.getContext('2d');
                    ctx.strokeStyle = "#000"; ctx.lineWidth = 2;
                    // Events
                    canvas.addEventListener('mousedown', startD); canvas.addEventListener('mouseup', endD); canvas.addEventListener('mousemove', draw);
                    canvas.addEventListener('touchstart', (e)=>{e.preventDefault(); startD(e.touches[0])}); canvas.addEventListener('touchend', endD); canvas.addEventListener('touchmove', (e)=>{e.preventDefault(); draw(e.touches[0])});
                };
                const startD = (e) => { isDrawing = true; draw(e); };
                const endD = () => { isDrawing = false; ctx.beginPath(); };
                const draw = (e) => {
                    if(!isDrawing) return;
                    const rect = sigPad.value.getBoundingClientRect();
                    const x = (e.clientX || e.pageX) - rect.left;
                    const y = (e.clientY || e.pageY) - rect.top;
                    ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
                };
                const clearSig = () => ctx.clearRect(0,0,sigPad.value.width,sigPad.value.height);
                const isCanvasBlank = () => !ctx.getImageData(0,0,sigPad.value.width,sigPad.value.height).data.some(c=>c!==0);

                // --- UTILS ---
                const navigate = (v) => { currentView.value = v; if(v==='dashboard') refreshData(); };
                const navClass = (v) => currentView.value===v ? 'flex items-center gap-3 px-4 py-3 bg-brand-600 text-white rounded-lg shadow transition cursor-pointer' : 'flex items-center gap-3 px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition cursor-pointer';
                const formatCurrency = (v) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(v);
                const formatDate = (d) => new Date(d).toLocaleDateString('th-TH');
                const statusBadge = (s) => ({'APPROVED':'bg-green-100 text-green-700','REJECTED':'bg-red-100 text-red-700','PENDING_HQ':'bg-orange-100 text-orange-700'}[s]||'bg-gray-100') + ' px-2 py-1 rounded text-xs font-bold';
                
                const filteredRequests = computed(() => {
                    return allRequests.value.filter(r => 
                        (!filters.value.zone || r.zone == filters.value.zone) &&
                        (!filters.value.status || r.status == filters.value.status) &&
                        (!filters.value.search || r.requester.toLowerCase().includes(filters.value.search.toLowerCase()))
                    );
                });

                return {
                    isLoading, loadingText, user, authMode, currentView,
                    loginForm, regForm, requestForm,
                    stats, pendingUsers, allRequests, myRequests, filteredRequests, filters,
                    handleLogin, handleRegister, logout, navigate,
                    submitRequest, handleFileUpload,
                    selectedRequest, openRequestDetail, processRequest, actionNote, sigPad, clearSig,
                    approveUser, downloadCSV,
                    previewUrl, viewFile, closePreview,
                    formatCurrency, formatDate, statusBadge, navClass, refreshData
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
