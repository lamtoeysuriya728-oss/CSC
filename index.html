<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: sans-serif; background: #f3f4f6; }
        .nav-item { cursor: pointer; padding: 10px 20px; color: #9ca3af; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover, .nav-item.active { background: #1f2937; color: white; border-left: 4px solid #3b82f6; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn { padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        canvas { border: 1px dashed #ccc; background: white; cursor: crosshair; }
    </style>
</head>
<body>

<div id="app" class="h-screen flex overflow-hidden">

    <div v-if="!user" class="fixed inset-0 bg-gray-900 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            
            <div class="flex bg-gray-100 p-1 rounded mb-4">
                <button @click="authMode='login'" :class="['flex-1 py-1 rounded', authMode=='login'?'bg-white shadow':'text-gray-500']">Login</button>
                <button @click="authMode='reg'" :class="['flex-1 py-1 rounded', authMode=='reg'?'bg-white shadow':'text-gray-500']">Register</button>
            </div>

            <form v-if="authMode=='login'" @submit.prevent="doLogin" class="space-y-3">
                <input v-model="login.email" placeholder="Email" class="w-full border p-2 rounded" required>
                <input v-model="login.pass" type="password" placeholder="Password" class="w-full border p-2 rounded" required>
                <button class="w-full bg-blue-600 text-white py-2 rounded">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>

            <form v-else @submit.prevent="doReg" class="space-y-3">
                <input v-model="reg.name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" class="w-full border p-2 rounded" required>
                <input v-model="reg.email" placeholder="Email" class="w-full border p-2 rounded" required>
                <input v-model="reg.pass" type="password" placeholder="Password" class="w-full border p-2 rounded" required>
                <input v-model="reg.zone" placeholder="Zone (1-15)" type="number" class="w-full border p-2 rounded" required>
                <input v-model="reg.dept" placeholder="‡πÅ‡∏ú‡∏ô‡∏Å/‡∏ù‡πà‡∏≤‡∏¢" class="w-full border p-2 rounded" required>
                <button class="w-full bg-green-600 text-white py-2 rounded">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
            </form>
        </div>
    </div>

    <template v-else>
        <aside class="w-64 bg-gray-900 text-white flex flex-col">
            <div class="h-16 flex items-center justify-center font-bold text-xl border-b border-gray-800">Admin HQ</div>
            <div class="flex-1 py-4">
                <div v-if="user.role=='ADMIN'">
                    <div @click="setPage('dash')" :class="['nav-item', page=='dash'?'active':'']"><i class="fas fa-chart-pie"></i> Dashboard</div>
                    <div @click="setPage('users')" :class="['nav-item', page=='users'?'active':'']"><i class="fas fa-users"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ <span v-if="stats.pendingU" class="ml-auto bg-red-500 px-2 rounded-full text-xs">{{stats.pendingU}}</span></div>
                    <div @click="setPage('reqs')" :class="['nav-item', page=='reqs'?'active':'']"><i class="fas fa-list"></i> ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span v-if="stats.pendingR" class="ml-auto bg-orange-500 px-2 rounded-full text-xs">{{stats.pendingR}}</span></div>
                    <div @click="setPage('export')" :class="['nav-item', page=='export'?'active':'']"><i class="fas fa-download"></i> Export</div>
                </div>
                <div v-else>
                    <div @click="setPage('create')" :class="['nav-item', page=='create'?'active':'']"><i class="fas fa-plus"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</div>
                    <div @click="setPage('my_reqs')" :class="['nav-item', page=='my_reqs'?'active':'']"><i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>
                </div>
            </div>
            <button @click="logout" class="p-4 bg-gray-800 hover:bg-red-600 text-center transition">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </aside>

        <main class="flex-1 bg-gray-100 flex flex-col overflow-hidden">
            <header class="bg-white h-16 shadow flex items-center justify-between px-6">
                <h2 class="font-bold text-xl">{{ pageTitle }}</h2>
                <div class="text-right text-sm">
                    <div class="font-bold">{{ user.name }}</div>
                    <div class="text-gray-500">{{ user.role }} | {{ user.dept }}</div>
                </div>
            </header>

            <div class="flex-1 overflow-auto p-6 relative">
                <div v-if="loading" class="absolute inset-0 bg-white/80 z-40 flex items-center justify-center"><i class="fas fa-circle-notch fa-spin text-4xl text-blue-500"></i></div>

                <div v-if="page=='dash'" class="grid grid-cols-4 gap-4">
                    <div class="card border-l-4 border-blue-500"><h3>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><p class="text-3xl font-bold">{{ stats.users }}</p></div>
                    <div class="card border-l-4 border-orange-500"><h3>‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠</h3><p class="text-3xl font-bold">{{ stats.pendingR }}</p></div>
                    <div class="card border-l-4 border-green-500"><h3>‡∏á‡∏ö‡πÉ‡∏ä‡πâ‡πÑ‡∏õ</h3><p class="text-2xl font-bold text-green-600">{{ currency(stats.used) }}</p></div>
                    <div class="card border-l-4 border-gray-500"><h3>‡∏á‡∏ö‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h3><p class="text-2xl font-bold text-blue-600">{{ currency(stats.budget - stats.used) }}</p></div>
                </div>

                <div v-if="page=='users'" class="card">
                    <table class="w-full text-sm text-left">
                        <thead><tr class="bg-gray-100"><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>Role</th><th>‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô</th><th>Action</th></tr></thead>
                        <tbody>
                            <tr v-for="u in pendingUsers" :key="u.email" class="border-b">
                                <td class="p-3">{{ u.name }}<br><span class="text-xs text-gray-400">{{ u.email }}</span></td>
                                <td class="p-3">{{ u.dept }}</td>
                                <td class="p-3"><select v-model="u.role" class="border p-1"><option>USER</option><option>ADMIN</option></select></td>
                                <td class="p-3"><input type="number" v-model="u.limit" class="border p-1 w-20"></td>
                                <td class="p-3"><button @click="appUser(u, true)" class="text-green-600 mr-2">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button><button @click="appUser(u, false)" class="text-red-600">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div v-if="page=='reqs' || page=='my_reqs'" class="card">
                    <table class="w-full text-sm text-left">
                        <thead><tr class="bg-gray-100"><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th><th>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th><th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th></th></tr></thead>
                        <tbody>
                            <tr v-for="r in requests" :key="r.id" class="border-b hover:bg-gray-50">
                                <td class="p-3">{{ date(r.date) }}</td>
                                <td class="p-3 font-bold">{{ r.title }}</td>
                                <td class="p-3">{{ r.requester }}</td>
                                <td class="p-3">{{ currency(r.amount) }}</td>
                                <td class="p-3"><span :class="badge(r.status)">{{ r.status }}</span></td>
                                <td class="p-3"><button @click="openReq(r)" class="text-blue-600 border px-2 py-1 rounded">‡∏î‡∏π</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div v-if="page=='create'" class="max-w-lg mx-auto card">
                    <h3 class="font-bold mb-4">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà</h3>
                    <div class="space-y-3">
                        <input v-model="newReq.title" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠" class="w-full border p-2 rounded">
                        <input v-model="newReq.amount" type="number" placeholder="‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì" class="w-full border p-2 rounded">
                        <textarea v-model="newReq.desc" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" class="w-full border p-2 rounded"></textarea>
                        <input type="file" @change="e => newReq.file = e.target.files[0]">
                        <button @click="submitReq" class="w-full bg-blue-600 text-white py-2 rounded font-bold">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
                    </div>
                </div>

                <div v-if="page=='export'" class="grid grid-cols-3 gap-4">
                    <div @click="exportCSV('Users')" class="card text-center cursor-pointer hover:shadow-lg">Export Users</div>
                    <div @click="exportCSV('Requests')" class="card text-center cursor-pointer hover:shadow-lg">Export Requests</div>
                    <div @click="exportCSV('Logs')" class="card text-center cursor-pointer hover:shadow-lg">Export Logs</div>
                </div>

            </div>
        </main>
    </template>

    <div v-if="selReq" class="fixed inset-0 bg-black/80 z-50 flex justify-center items-center p-4">
        <div class="bg-white w-full max-w-lg rounded-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 border-b flex justify-between bg-gray-50">
                <h3 class="font-bold">{{ selReq.title }}</h3>
                <button @click="selReq=null">‚úï</button>
            </div>
            <div class="p-6 overflow-y-auto space-y-4">
                <div class="bg-blue-50 p-4 rounded text-sm">
                    <p><b>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠:</b> {{ selReq.requester }}</p>
                    <p><b>‡∏á‡∏ö:</b> {{ currency(selReq.amount) }}</p>
                    <p><b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</b> {{ selReq.desc }}</p>
                </div>
                <div v-if="selReq.fileId">
                    <a :href="'https://drive.google.com/file/d/'+selReq.fileId+'/preview'" target="_blank" class="text-blue-600 underline">‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</a>
                </div>

                <div v-if="user.role=='ADMIN' && selReq.status=='PENDING_HQ'" class="border-t pt-4">
                    <p class="font-bold text-red-500 mb-2">‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
                    <textarea v-model="note" class="w-full border p-2 text-sm mb-2" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"></textarea>
                    <canvas ref="sig" width="400" height="120" class="w-full border mb-2"></canvas>
                    <button @click="clearSig" class="text-xs text-red-500 mb-2 block text-right">‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</button>
                    <div class="flex gap-2">
                        <button @click="procReq('APPROVED')" class="flex-1 bg-green-600 text-white py-2 rounded">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                        <button @click="procReq('REJECTED')" class="flex-1 bg-red-600 text-white py-2 rounded">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                    </div>
                </div>
                
                <div v-if="selReq.status!='PENDING_HQ'" class="text-center p-2 bg-gray-100 rounded">
                    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: {{ selReq.status }} <br> Note: {{ selReq.note }}
                </div>
            </div>
        </div>
    </div>

</div>

<script>
// üî¥ ‡πÅ‡∏Å‡πâ URL ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
const API = "https://script.google.com/macros/s/AKfycbxp-YIEuinnWRrn8mYPKNEKmu39vFgBzXsAi_9REJj56MGs7LldrtGTJIgqThh3c9cp/exec"; 

const { createApp } = Vue;
createApp({
    data() {
        return {
            loading: false, user: null, authMode: 'login', page: 'dash',
            login: {email:'', pass:''}, reg: {name:'', email:'', password:'', zone:'', dept:'', branch:''},
            stats: {}, pendingUsers: [], requests: [], newReq: {title:'', amount:'', desc:'', file:null},
            selReq: null, note: '', ctx: null, isDrawing: false
        }
    },
    computed: {
        pageTitle() { return {'dash':'Dashboard', 'users':'Approve Users', 'reqs':'Requests', 'create':'Create Request', 'my_reqs':'My History'}[this.page] || this.page }
    },
    methods: {
        async api(payload) {
            this.loading = true;
            try { return await (await fetch(API, {method:'POST', body:JSON.stringify(payload)})).json(); }
            catch { return null; } finally { this.loading = false; }
        },
        async doLogin() {
            const r = await this.api({action:'login', email:this.login.email, password:this.login.pass});
            if(r?.status=='success') { this.user=r.user; this.page=this.user.role=='ADMIN'?'dash':'my_reqs'; this.loadData(); }
            else Swal.fire('Error', r?.message, 'error');
        },
        async doReg() {
            const r = await this.api({action:'register', ...this.reg});
            if(r?.status=='success') { Swal.fire('OK','Wait Admin','success'); this.authMode='login'; }
        },
        logout() { this.user=null; this.login={}; },
        setPage(p) { this.page=p; this.loadData(); },
        async loadData() {
            const r = await this.api({action:'getData', role:this.user.role, email:this.user.email});
            if(r?.status=='success') {
                this.stats=r.data.stats; 
                this.pendingUsers=r.data.pendingUsers; 
                this.requests=r.data.requests;
            }
        },
        async submitReq() {
            let fileData=null, fileName=null;
            if(this.newReq.file) {
                fileData = await new Promise(r=>{const fr=new FileReader(); fr.onload=e=>r(e.target.result); fr.readAsDataURL(this.newReq.file)});
                fileName = this.newReq.file.name;
            }
            const r = await this.api({action:'createRequest', ...this.newReq, name:this.user.name, email:this.user.email, dept:this.user.dept, zone:this.user.zone, fileData, fileName, mime:this.newReq.file?.type});
            if(r?.status=='success') { Swal.fire('OK','Sent','success'); this.newReq={}; this.page='my_reqs'; this.loadData(); }
        },
        async appUser(u, ok) {
            await this.api({action:'approveUser', target:u.email, approve:ok, role:u.role, limit:u.limit});
            this.loadData();
        },
        openReq(r) { 
            this.selReq=r; this.note=''; 
            if(r.status=='PENDING_HQ') setTimeout(this.initSig, 300);
        },
        async procReq(status) {
            if(status=='APPROVED' && this.isBlank()) return alert('Sign please');
            const sig = this.$refs.sig ? this.$refs.sig.toDataURL() : '';
            await this.api({action:'processReq', id:this.selReq.id, status, note:this.note, sig});
            this.selReq=null; this.loadData();
        },
        async exportCSV(type) {
            const r = await this.api({action:'export', type});
            if(r?.status=='success') {
                let csv = "data:text/csv;charset=utf-8," + r.data.map(e=>e.join(",")).join("\n");
                let a = document.createElement("a"); a.href=encodeURI(csv); a.download=type+".csv"; a.click();
            }
        },
        // Utils
        currency(v) { return new Intl.NumberFormat('th-TH',{style:'currency',currency:'THB'}).format(v); },
        date(d) { return new Date(d).toLocaleDateString('th-TH'); },
        badge(s) { return (s=='APPROVED'?'bg-green-100 text-green-700':s=='REJECTED'?'bg-red-100 text-red-700':'bg-orange-100 text-orange-700')+' px-2 rounded text-xs font-bold'; },
        // Canvas
        initSig() {
            const c=this.$refs.sig; this.ctx=c.getContext('2d'); this.ctx.lineWidth=2;
            c.onmousedown=c.ontouchstart=e=>{this.isD=true; this.draw(e)};
            c.onmouseup=c.ontouchend=()=>{this.isD=false; this.ctx.beginPath()};
            c.onmousemove=c.ontouchmove=e=>{if(this.isD) this.draw(e)};
        },
        draw(e) {
            e.preventDefault(); const r=this.$refs.sig.getBoundingClientRect();
            const x=(e.clientX||e.touches[0].clientX)-r.left, y=(e.clientY||e.touches[0].clientY)-r.top;
            this.ctx.lineTo(x,y); this.ctx.stroke(); this.ctx.beginPath(); this.ctx.moveTo(x,y);
        },
        clearSig() { this.ctx.clearRect(0,0,400,120); },
        isBlank() { return !this.ctx.getImageData(0,0,400,120).data.some(c=>c!==0); }
    }
}).mount('#app');
</script>
</body>
</html>
