<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡∏™‡∏ô‡∏ç.) - Admin Console</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: { extend: { fontFamily: { sans: ['Sarabun', 'sans-serif'] }, colors: { brand: { 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' } } } }
        }
    </script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        canvas { border: 2px dashed #94a3b8; cursor: crosshair; }
    </style>
</head>
<body>

    <div id="app" class="h-screen w-full flex flex-col overflow-hidden text-slate-800">

        <div v-if="isLoading" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center text-white flex-col backdrop-blur-sm">
            <i class="fas fa-circle-notch fa-spin text-5xl mb-4 text-brand-500"></i>
            <p class="text-xl animate-pulse">{{ loadingText }}</p>
        </div>

        <div v-if="!user" class="flex-1 flex items-center justify-center bg-brand-900 bg-opacity-95 p-4" 
             style="background-image: url('https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?auto=format'); background-size: cover; background-blend-mode: multiply;">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-8">
                <div class="text-center mb-6">
                    <img src="https://cdn-icons-png.flaticon.com/512/900/900782.png" class="w-16 h-16 mx-auto mb-2 opacity-80">
                    <h1 class="text-2xl font-bold text-gray-800">Admin Console</h1>
                    <p class="text-gray-500">‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏á‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡∏™‡∏ô‡∏ç.)</p>
                </div>
                <form @submit.prevent="handleLogin" class="space-y-4">
                    <input v-model="loginForm.email" type="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-brand-500 outline-none">
                    <input v-model="loginForm.password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-brand-500 outline-none">
                    <button type="submit" class="w-full bg-brand-600 text-white py-3 rounded-lg font-bold hover:bg-brand-700 shadow-lg transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <p class="text-xs text-center text-gray-400 mt-2">demo: admin@demo.com / 1234 (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÉ‡∏ô Sheet ‡∏Å‡πà‡∏≠‡∏ô)</p>
                </form>
            </div>
        </div>

        <div v-else class="flex flex-1 overflow-hidden">
            
            <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col shadow-xl z-20">
                <div class="p-6 border-b border-slate-700">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-brand-500 text-white flex items-center justify-center font-bold text-lg">A</div>
                        <div>
                            <h2 class="font-bold text-white truncate w-32">{{ user.name }}</h2>
                            <p class="text-xs text-brand-400">SUPER ADMIN</p>
                        </div>
                    </div>
                </div>
                <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                    <p class="text-xs font-bold text-slate-500 uppercase px-3 mb-2">Main</p>
                    <a @click="currentView='dashboard'" :class="navClass('dashboard')" class="nav-item"><i class="fas fa-chart-pie w-6"></i> Dashboard</a>
                    
                    <p class="text-xs font-bold text-slate-500 uppercase px-3 mt-6 mb-2">Management</p>
                    <a @click="currentView='users'" :class="navClass('users')" class="nav-item">
                        <i class="fas fa-user-check w-6"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£
                        <span v-if="stats.pendingUserCount > 0" class="ml-auto bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">{{ stats.pendingUserCount }}</span>
                    </a>
                    <a @click="currentView='requests'" :class="navClass('requests')" class="nav-item">
                        <i class="fas fa-file-invoice-dollar w-6"></i> ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏ö
                        <span v-if="stats.pendingReqCount > 0" class="ml-auto bg-orange-500 text-white text-xs px-2 py-0.5 rounded-full">{{ stats.pendingReqCount }}</span>
                    </a>
                    <a @click="currentView='documents'" :class="navClass('documents')" class="nav-item"><i class="fas fa-folder-open w-6"></i> ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>

                    <p class="text-xs font-bold text-slate-500 uppercase px-3 mt-6 mb-2">System</p>
                    <a @click="currentView='export'" :class="navClass('export')" class="nav-item"><i class="fas fa-file-export w-6"></i> Export / ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</a>
                    <a @click="currentView='logs'" :class="navClass('logs')" class="nav-item"><i class="fas fa-shield-alt w-6"></i> Audit Logs</a>
                </nav>
                <div class="p-4 bg-slate-800">
                    <button @click="logout" class="w-full flex items-center gap-2 text-red-400 hover:text-red-300 transition"><i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </aside>

            <main class="flex-1 flex flex-col bg-slate-50 overflow-hidden relative">
                
                <header class="bg-white shadow-sm px-8 py-4 flex justify-between items-center z-10">
                    <h2 class="text-xl font-bold text-slate-700 capitalize"><i class="fas fa-chevron-right text-brand-500 mr-2 text-sm"></i> {{ currentView }}</h2>
                    <div class="flex gap-4 text-sm text-gray-500">
                        <span><i class="fas fa-building mr-1"></i> ‡∏™‡∏ô‡∏ç.</span>
                        <span><i class="fas fa-calendar mr-1"></i> {{ new Date().toLocaleDateString('th-TH') }}</span>
                    </div>
                </header>

                <div class="flex-1 overflow-auto p-8">

                    <div v-if="currentView === 'dashboard'" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-blue-500">
                                <p class="text-gray-500 text-sm">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                                <p class="text-3xl font-bold text-gray-800">{{ stats.totalUsers }}</p>
                                <p class="text-xs text-blue-500 mt-1">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ {{ stats.pendingUserCount }} ‡∏Ñ‡∏ô</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-orange-500">
                                <p class="text-gray-500 text-sm">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
                                <p class="text-3xl font-bold text-gray-800">{{ stats.pendingReqCount }}</p>
                                <p class="text-xs text-orange-500 mt-1">‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î {{ stats.totalReq }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-green-500">
                                <p class="text-gray-500 text-sm">‡∏á‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß (‡πÉ‡∏ä‡πâ‡πÑ‡∏õ)</p>
                                <p class="text-2xl font-bold text-green-600">{{ formatCurrency(stats.usedBudget) }}</p>
                                <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2">
                                    <div class="bg-green-500 h-1.5 rounded-full" :style="`width: ${(stats.usedBudget / 1000000)*100}%`"></div>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-purple-500">
                                <p class="text-gray-500 text-sm">‡πÇ‡∏ã‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</p>
                                <p class="text-3xl font-bold text-gray-800">Zone {{ stats.maxZone }}</p>
                                <p class="text-xs text-purple-500 mt-1">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô</p>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-lg">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>
                                <button @click="currentView='requests'" class="text-brand-600 text-sm hover:underline">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                            </div>
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 text-gray-500"><tr><th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-3">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th><th class="p-3">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th><th class="p-3 text-right">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th><th class="p-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                                <tbody class="divide-y">
                                    <tr v-for="req in pendingRequests.slice(0,5)" :key="req.id">
                                        <td class="p-3">{{ formatDate(req.timestamp) }}</td>
                                        <td class="p-3 font-medium">{{ req.title }}</td>
                                        <td class="p-3">{{ req.requester }} (Zone {{ req.zone }})</td>
                                        <td class="p-3 text-right">{{ formatCurrency(req.amount) }}</td>
                                        <td class="p-3 text-center"><button @click="openRequestDetail(req)" class="text-brand-600 hover:bg-brand-50 px-3 py-1 rounded border border-brand-200">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div v-if="currentView === 'users'" class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="font-bold text-lg mb-4 text-gray-800">‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 text-gray-500 uppercase"><tr><th class="p-3">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th class="p-3">‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</th><th class="p-3">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Role)</th><th class="p-3">‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô (Limit)</th><th class="p-3 text-right">Action</th></tr></thead>
                                <tbody class="divide-y">
                                    <tr v-for="u in pendingUsers" :key="u.email" class="hover:bg-gray-50">
                                        <td class="p-3">
                                            <div class="font-bold">{{ u.name }}</div>
                                            <div class="text-xs text-gray-400">{{ u.email }}</div>
                                        </td>
                                        <td class="p-3">
                                            <div>{{ u.department }}</div>
                                            <div class="text-xs text-gray-500">{{ u.branch }} (Zone {{ u.zone }})</div>
                                        </td>
                                        <td class="p-3">
                                            <select v-model="u.tempRole" class="border rounded px-2 py-1 bg-white">
                                                <option value="USER">Requester</option>
                                                <option value="APPROVER">Zone Approver</option>
                                                <option value="ADMIN">HQ Admin</option>
                                            </select>
                                        </td>
                                        <td class="p-3">
                                            <input type="number" v-model="u.tempLimit" class="border rounded px-2 py-1 w-24 text-right" placeholder="0">
                                        </td>
                                        <td class="p-3 text-right">
                                            <button @click="approveUser(u)" class="bg-green-600 text-white px-3 py-1.5 rounded shadow hover:bg-green-700 text-xs font-bold">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                        </td>
                                    </tr>
                                    <tr v-if="pendingUsers.length === 0"><td colspan="5" class="p-8 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div v-if="currentView === 'requests'" class="space-y-4">
                        <div class="bg-white p-4 rounded-xl shadow-sm flex flex-wrap gap-4 items-center">
                            <span class="font-bold text-gray-600"><i class="fas fa-filter"></i> ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á:</span>
                            <select v-model="filters.zone" class="border rounded px-3 py-2 text-sm"><option value="">‡∏ó‡∏∏‡∏Å‡πÇ‡∏ã‡∏ô</option><option v-for="n in 15" :value="n">Zone {{ n }}</option></select>
                            <select v-model="filters.status" class="border rounded px-3 py-2 text-sm"><option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option><option value="PENDING_HQ">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option><option value="APPROVED">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</option><option value="REJECTED">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</option></select>
                            <input v-model="filters.search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠..." class="border rounded px-3 py-2 text-sm w-64">
                        </div>

                        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 text-gray-500 uppercase"><tr><th class="p-4">ID/‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-4">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th><th class="p-4">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th><th class="p-4 text-right">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</th><th class="p-4 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="p-4 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                                <tbody class="divide-y">
                                    <tr v-for="req in filteredRequests" :key="req.id" class="hover:bg-gray-50 transition cursor-pointer" @click="openRequestDetail(req)">
                                        <td class="p-4"><div class="font-bold text-brand-700">{{ req.id }}</div><div class="text-xs text-gray-400">{{ formatDate(req.timestamp) }}</div></td>
                                        <td class="p-4 font-medium">{{ req.title }}</td>
                                        <td class="p-4">{{ req.requester }}<br><span class="text-xs text-gray-500">Zone {{ req.zone }}</span></td>
                                        <td class="p-4 text-right font-mono">{{ formatCurrency(req.amount) }}</td>
                                        <td class="p-4 text-center"><span :class="statusBadge(req.status)">{{ req.status }}</span></td>
                                        <td class="p-4 text-center"><button class="text-gray-400 hover:text-brand-600"><i class="fas fa-eye"></i></button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div v-if="currentView === 'documents'" class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="font-bold text-lg mb-4">‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50"><tr><th class="p-3">ID</th><th class="p-3">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th><th class="p-3">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö (User)</th><th class="p-3">‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Admin)</th></tr></thead>
                            <tbody class="divide-y">
                                <tr v-for="req in allRequests.filter(r => r.status === 'APPROVED')" :key="req.id">
                                    <td class="p-3">{{ req.id }}</td>
                                    <td class="p-3">{{ req.title }}</td>
                                    <td class="p-3"><a href="#" class="text-blue-500 hover:underline"><i class="fas fa-paperclip"></i> File</a></td>
                                    <td class="p-3"><a href="#" class="text-green-600 hover:underline"><i class="fas fa-file-pdf"></i> Approved.pdf</a></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div v-if="currentView === 'export'" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-8 rounded-xl shadow-sm text-center">
                            <i class="fas fa-users text-4xl text-blue-500 mb-4"></i>
                            <h3 class="font-bold text-lg">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
                            <button @click="downloadCSV('users')" class="mt-4 bg-blue-50 text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-100 w-full font-bold">Download CSV</button>
                        </div>
                        <div class="bg-white p-8 rounded-xl shadow-sm text-center">
                            <i class="fas fa-file-invoice-dollar text-4xl text-green-500 mb-4"></i>
                            <h3 class="font-bold text-lg">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                            <button @click="downloadCSV('requests')" class="mt-4 bg-green-50 text-green-600 px-4 py-2 rounded-lg hover:bg-green-100 w-full font-bold">Download CSV</button>
                        </div>
                        <div class="bg-white p-8 rounded-xl shadow-sm text-center">
                            <i class="fas fa-shield-alt text-4xl text-gray-500 mb-4"></i>
                            <h3 class="font-bold text-lg">Audit Logs</h3>
                            <button @click="downloadCSV('logs')" class="mt-4 bg-gray-100 text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-200 w-full font-bold">Download CSV</button>
                        </div>
                    </div>

                    <div v-if="currentView === 'logs'" class="bg-gray-900 text-green-400 p-6 rounded-xl shadow-lg font-mono text-xs h-full overflow-auto">
                        <p class="mb-4 text-white border-b border-gray-700 pb-2">>> SYSTEM AUDIT LOGS START...</p>
                        <div v-for="i in 10" :key="i" class="mb-1">
                            <span class="text-gray-500">[2023-10-{{10+i}} 14:{{30+i}}]</span> 
                            <span class="text-yellow-400">ADMIN</span> executed 
                            <span class="text-blue-400">APPROVE_REQUEST</span> on target REQ-100{{i}}
                        </div>
                        <p class="mt-4 text-gray-500">(‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Log 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î - ‡∏Å‡∏î Export ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</p>
                    </div>

                </div>

                <div v-if="selectedRequest" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-end">
                    <div class="bg-white w-full max-w-2xl h-full shadow-2xl p-8 overflow-y-auto flex flex-col animate-slide-in-right">
                        
                        <div class="flex justify-between items-start mb-6 pb-4 border-b">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">{{ selectedRequest.title }}</h2>
                                <p class="text-gray-500 text-sm">ID: {{ selectedRequest.id }} | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {{ formatDate(selectedRequest.timestamp) }}</p>
                            </div>
                            <button @click="selectedRequest = null" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-2xl"></i></button>
                        </div>

                        <div class="space-y-6 flex-1">
                            <div class="bg-blue-50 p-4 rounded-lg flex justify-between items-center">
                                <div>
                                    <p class="text-xs text-blue-500 uppercase font-bold">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
                                    <p class="font-bold text-gray-800">{{ selectedRequest.requester }}</p>
                                    <p class="text-sm text-gray-600">‡∏ù‡πà‡∏≤‡∏¢: {{ selectedRequest.department }} | Zone {{ selectedRequest.zone }}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-blue-500 uppercase font-bold">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</p>
                                    <p class="text-2xl font-bold text-brand-600 font-mono">{{ formatCurrency(selectedRequest.amount) }}</p>
                                </div>
                            </div>

                            <div>
                                <h3 class="font-bold text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î / ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</h3>
                                <div class="p-4 bg-gray-50 rounded-lg text-gray-600 text-sm leading-relaxed">
                                    {{ selectedRequest.description }}
                                </div>
                            </div>

                            <div>
                                <h3 class="font-bold text-gray-700 mb-2">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</h3>
                                <a href="#" class="inline-flex items-center gap-2 px-4 py-2 bg-white border rounded-lg text-sm hover:bg-gray-50">
                                    <i class="fas fa-file-pdf text-red-500"></i> Project_Proposal.pdf
                                </a>
                            </div>

                            <div v-if="selectedRequest.status === 'PENDING_HQ'" class="border-t pt-6">
                                <h3 class="font-bold text-gray-800 mb-4">‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>
                                
                                <label class="block text-sm text-gray-600 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô (Admin Note)</label>
                                <textarea v-model="actionNote" class="w-full border rounded-lg p-3 text-sm mb-4" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö..."></textarea>
                                
                                <label class="block text-sm text-gray-600 mb-1">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ <span class="text-red-500">*</span></label>
                                <canvas ref="sigPad" width="500" height="150" class="w-full bg-white border-2 border-dashed rounded-lg mb-2"></canvas>
                                <button @click="clearSig" class="text-xs text-red-500 hover:underline mb-4">‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</button>

                                <div class="grid grid-cols-2 gap-4">
                                    <button @click="processRequest('REJECTED')" class="py-3 rounded-lg border border-red-200 text-red-600 font-bold hover:bg-red-50">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / ‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö</button>
                                    <button @click="processRequest('APPROVED')" class="py-3 rounded-lg bg-brand-600 text-white font-bold hover:bg-brand-700 shadow">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠ (Approve)</button>
                                </div>
                            </div>

                            <div v-else class="border-t pt-6 text-center">
                                <div v-if="selectedRequest.status === 'APPROVED'" class="text-green-600">
                                    <i class="fas fa-check-circle text-4xl mb-2"></i>
                                    <h3 class="font-bold text-xl">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</h3>
                                    <p class="text-sm">‡πÄ‡∏°‡∏∑‡πà‡∏≠ {{ formatDate(selectedRequest.approvedDate || new Date()) }}</p>
                                    <p class="text-sm mt-2 text-gray-500">Note: {{ selectedRequest.adminNote }}</p>
                                </div>
                                <div v-if="selectedRequest.status === 'REJECTED'" class="text-red-600">
                                    <i class="fas fa-times-circle text-4xl mb-2"></i>
                                    <h3 class="font-bold text-xl">‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</h3>
                                    <p class="text-sm">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: {{ selectedRequest.adminNote }}</p>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, nextTick } = Vue;
        const API_URL = "https://script.google.com/macros/s/AKfycbzuGfNO9qO2XLBrZOUTeaNlGx3e9W2kwS2Uz5M7p_mprnwJNo1fHTBE3nVrxETTN8wx/exec"; // üî¥ REPLACE THIS

        createApp({
            setup() {
                // STATE
                const isLoading = ref(false);
                const loadingText = ref('');
                const user = ref(null);
                const currentView = ref('dashboard');
                const selectedRequest = ref(null);
                
                // DATA
                const loginForm = ref({ email: '', password: '' });
                const stats = ref({});
                const pendingUsers = ref([]);
                const allRequests = ref([]);
                const filters = ref({ zone: '', status: '', search: '' });
                const actionNote = ref('');
                
                // SIGNATURE
                const sigPad = ref(null);
                let ctx = null, isDrawing = false;

                // API HELPER
                const callApi = async (payload) => {
                    isLoading.value = true;
                    try {
                        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                        return await res.json();
                    } catch { return { status: 'error', message: 'Connection Failed' }; }
                    finally { isLoading.value = false; }
                };

                // ACTIONS
                const handleLogin = async () => {
                    loadingText.value = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
                    const res = await callApi({ action: 'login', ...loginForm.value });
                    if(res.status === 'success') {
                        user.value = res;
                        fetchData();
                    } else Swal.fire('Error', res.message, 'error');
                };

                const fetchData = async () => {
                    const res = await callApi({ action: 'getAdminData' });
                    if(res.status === 'success') {
                        stats.value = res.data.stats;
                        pendingUsers.value = res.data.pendingUsers.map(u => ({...u, tempRole: 'USER', tempLimit: 0}));
                        allRequests.value = res.data.allRequests;
                    }
                };

                const approveUser = async (u) => {
                    if(!u.tempLimit) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô', 'warning');
                    const res = await callApi({ 
                        action: 'approveUser', 
                        targetEmail: u.email, 
                        adminEmail: user.value.email,
                        role: u.tempRole, 
                        limit: u.tempLimit 
                    });
                    if(res.status === 'success') {
                        Swal.fire('Success', '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                        fetchData();
                    }
                };

                const openRequestDetail = (req) => {
                    selectedRequest.value = req;
                    actionNote.value = '';
                    if(req.status === 'PENDING_HQ') {
                        nextTick(initSigPad);
                    }
                };

                const processRequest = async (status) => {
                    if(status === 'APPROVED' && isCanvasBlank()) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏Å‡∏±‡∏ö', 'warning');
                    
                    loadingText.value = status === 'APPROVED' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ PDF...' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                    const signature = sigPad.value.toDataURL();

                    const res = await callApi({
                        action: 'processRequest',
                        reqId: selectedRequest.value.id,
                        status: status,
                        note: actionNote.value,
                        signature: signature,
                        adminEmail: user.value.email
                    });

                    if(res.status === 'success') {
                        Swal.fire('Completed', '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', 'success');
                        selectedRequest.value = null;
                        fetchData();
                    }
                };

                const downloadCSV = async (type) => {
                    loadingText.value = 'Preparing Download...';
                    const res = await callApi({ action: 'exportData', type: type, adminEmail: user.value.email });
                    if(res.status === 'success') {
                        let csv = "data:text/csv;charset=utf-8," + res.data.map(e => e.join(",")).join("\n");
                        let link = document.createElement("a");
                        link.href = encodeURI(csv);
                        link.download = `export_${type}.csv`;
                        link.click();
                    }
                };

                const logout = () => { user.value = null; loginForm.value = { email: '', password: '' }; };

                // SIGNATURE LOGIC
                const initSigPad = () => {
                    const canvas = sigPad.value;
                    if(!canvas) return;
                    ctx = canvas.getContext('2d');
                    ctx.strokeStyle = "#000"; ctx.lineWidth = 2;
                    canvas.addEventListener('mousedown', startD); canvas.addEventListener('mouseup', endD); canvas.addEventListener('mousemove', draw);
                    canvas.addEventListener('touchstart', (e)=>{e.preventDefault(); startD(e.touches[0])}); canvas.addEventListener('touchend', endD); canvas.addEventListener('touchmove', (e)=>{e.preventDefault(); draw(e.touches[0])});
                };
                let startD = (e) => { isDrawing = true; draw(e); };
                let endD = () => { isDrawing = false; ctx.beginPath(); };
                let draw = (e) => {
                    if(!isDrawing) return;
                    const rect = sigPad.value.getBoundingClientRect();
                    const x = (e.clientX || e.pageX) - rect.left;
                    const y = (e.clientY || e.pageY) - rect.top;
                    ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
                };
                const clearSig = () => ctx.clearRect(0, 0, sigPad.value.width, sigPad.value.height);
                const isCanvasBlank = () => !ctx.getImageData(0,0,sigPad.value.width,sigPad.value.height).data.some(c=>c!==0);

                // COMPUTED & UTILS
                const filteredRequests = computed(() => {
                    return allRequests.value.filter(r => {
                        return (!filters.value.zone || r.zone == filters.value.zone) &&
                               (!filters.value.status || r.status == filters.value.status) &&
                               (!filters.value.search || r.requester.includes(filters.value.search));
                    });
                });
                const pendingRequests = computed(() => allRequests.value.filter(r => r.status === 'PENDING_HQ'));
                
                const navClass = (view) => currentView.value === view ? 'bg-brand-600 text-white flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer transition' : 'text-slate-400 hover:bg-slate-800 hover:text-white flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer transition';
                const statusBadge = (s) => ({'APPROVED':'bg-green-100 text-green-700','REJECTED':'bg-red-100 text-red-700','PENDING_HQ':'bg-orange-100 text-orange-700'}[s] || 'bg-gray-100') + ' px-2 py-1 rounded text-xs font-bold';
                const formatCurrency = (v) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(v);
                const formatDate = (d) => new Date(d).toLocaleDateString('th-TH');

                return {
                    isLoading, loadingText, user, loginForm, handleLogin, logout,
                    currentView, navClass, stats, pendingUsers, 
                    filters, filteredRequests, pendingRequests,
                    approveUser, openRequestDetail, selectedRequest, processRequest, actionNote,
                    sigPad, clearSig, downloadCSV,
                    formatCurrency, formatDate, statusBadge
                };
            }
        }).mount('#app');
    </script>
    <style> .nav-item { margin-bottom: 4px; } </style>
</body>
</html>
