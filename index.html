<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console - ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏•‡∏≤‡∏á</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f3f4f6; }
        .sidebar-link { @apply flex items-center px-6 py-3 text-gray-400 hover:bg-gray-800 hover:text-white cursor-pointer transition-colors border-l-4 border-transparent; }
        .sidebar-link.active { @apply bg-gray-800 text-white border-blue-500; }
        .card { @apply bg-white rounded-lg shadow-sm p-6; }
        /* Table Styles */
        .admin-table { @apply min-w-full text-sm text-left text-gray-500; }
        .admin-table thead { @apply text-xs text-gray-700 uppercase bg-gray-100; }
        .admin-table th, .admin-table td { @apply px-6 py-3 border-b; }
        .btn { @apply px-4 py-2 rounded text-sm font-medium transition shadow-sm; }
    </style>
</head>
<body>
    <div id="app" class="h-screen flex overflow-hidden">

        <aside class="w-64 bg-gray-900 flex flex-col shadow-2xl z-20">
            <div class="h-16 flex items-center justify-center border-b border-gray-800">
                <h1 class="text-white font-bold text-lg"><i class="fas fa-shield-alt mr-2 text-blue-500"></i> Admin HQ</h1>
            </div>
            
            <div class="flex-1 overflow-y-auto py-4">
                <nav v-if="user">
                    <p class="px-6 text-xs text-gray-500 uppercase font-bold mb-2">Main</p>
                    <a @click="view='dashboard'" :class="['sidebar-link', view==='dashboard'?'active':'']"><i class="fas fa-chart-pie w-6"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</a>
                    
                    <p class="px-6 text-xs text-gray-500 uppercase font-bold mb-2 mt-6">Management</p>
                    <a @click="view='users'" :class="['sidebar-link', view==='users'?'active':'']">
                        <i class="fas fa-user-check w-6"></i> ‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                        <span v-if="stats.pendingUserCount > 0" class="ml-auto bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">{{ stats.pendingUserCount }}</span>
                    </a>
                    <a @click="view='requests'" :class="['sidebar-link', view==='requests'?'active':'']">
                        <i class="fas fa-file-invoice-dollar w-6"></i> ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        <span v-if="stats.pendingReqCount > 0" class="ml-auto bg-orange-500 text-white text-xs px-2 py-0.5 rounded-full">{{ stats.pendingReqCount }}</span>
                    </a>
                    <a @click="view='documents'" :class="['sidebar-link', view==='documents'?'active':'']"><i class="fas fa-folder-open w-6"></i> ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>

                    <p class="px-6 text-xs text-gray-500 uppercase font-bold mb-2 mt-6">System</p>
                    <a @click="view='export'" :class="['sidebar-link', view==='export'?'active':'']"><i class="fas fa-file-export w-6"></i> Export / ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</a>
                    <a @click="view='logs'" :class="['sidebar-link', view==='logs'?'active':'']"><i class="fas fa-history w-6"></i> Audit Logs</a>
                </nav>
            </div>

            <div class="p-4 bg-gray-800">
                <button @click="logout" class="flex items-center text-red-400 hover:text-white transition text-sm">
                    <i class="fas fa-sign-out-alt mr-2"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden bg-gray-100">
            
            <header class="bg-white shadow-sm h-16 flex justify-between items-center px-8 z-10">
                <h2 class="text-xl font-bold text-gray-800 capitalize">{{ pageTitle }}</h2>
                <div v-if="user" class="flex items-center gap-4">
                    <div class="text-right">
                        <p class="text-sm font-bold text-gray-900">{{ user.name }}</p>
                        <p class="text-xs text-blue-600 font-bold uppercase">{{ user.role }}</p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold">
                        {{ user.name.charAt(0) }}
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-auto p-8 relative">

                <div v-if="isLoading" class="absolute inset-0 bg-white/80 z-50 flex flex-col items-center justify-center backdrop-blur-sm">
                    <i class="fas fa-circle-notch fa-spin text-4xl text-blue-500 mb-2"></i>
                    <p class="text-gray-500 animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>

                <div v-if="!user" class="max-w-md mx-auto mt-20">
                    <div class="bg-white p-8 rounded-xl shadow-lg border-t-4 border-blue-600">
                        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin HQ</h2>
                        <form @submit.prevent="handleLogin" class="space-y-4">
                            <input v-model="loginForm.email" type="email" placeholder="Email" class="w-full border p-3 rounded focus:ring-2 focus:ring-blue-500 outline-none" required>
                            <input v-model="loginForm.password" type="password" placeholder="Password" class="w-full border p-3 rounded focus:ring-2 focus:ring-blue-500 outline-none" required>
                            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700 transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                        </form>
                        <p class="text-xs text-center text-gray-400 mt-4">‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ Role: ADMIN ‡πÉ‡∏ô Google Sheet ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                    </div>
                </div>

                <div v-else>
                    <div v-if="view === 'dashboard'" class="space-y-6">
                        <div class="flex justify-end"><button @click="refreshData" class="text-blue-600 text-sm hover:underline"><i class="fas fa-sync"></i> Refresh Real-time</button></div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div class="card border-l-4 border-blue-500">
                                <p class="text-gray-400 text-xs uppercase">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                                <p class="text-3xl font-bold text-gray-800">{{ stats.totalUsers }}</p>
                                <p class="text-xs text-green-500 mt-1">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ {{ stats.activeUserCount }}</p>
                            </div>
                            <div class="card border-l-4 border-yellow-500">
                                <p class="text-gray-400 text-xs uppercase">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ</p>
                                <p class="text-3xl font-bold text-gray-800">{{ stats.pendingUserCount }}</p>
                                <p class="text-xs text-yellow-600 mt-1">‡∏Ñ‡∏ô</p>
                            </div>
                            <div class="card border-l-4 border-orange-500">
                                <p class="text-gray-400 text-xs uppercase">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
                                <p class="text-3xl font-bold text-gray-800">{{ stats.pendingReqCount }}</p>
                                <p class="text-xs text-gray-400 mt-1">‡∏à‡∏≤‡∏Å {{ stats.totalRequests }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                            </div>
                            <div class="card border-l-4 border-purple-500">
                                <p class="text-gray-400 text-xs uppercase">‡πÇ‡∏ã‡∏ô‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï</p>
                                <p class="text-3xl font-bold text-gray-800">Zone {{ stats.maxZone }}</p>
                                <p class="text-xs text-purple-500 mt-1">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="card bg-gray-800 text-white">
                                <p class="text-gray-400 text-xs uppercase">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</p>
                                <p class="text-2xl font-bold text-green-400 mt-2">{{ formatMoney(10000000) }}</p>
                            </div>
                            <div class="card">
                                <p class="text-gray-400 text-xs uppercase">‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</p>
                                <p class="text-2xl font-bold text-red-600 mt-2">{{ formatMoney(stats.usedBudgetVal) }}</p>
                            </div>
                            <div class="card">
                                <p class="text-gray-400 text-xs uppercase">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
                                <p class="text-2xl font-bold text-blue-600 mt-2">{{ formatMoney(stats.remainingBudgetVal) }}</p>
                            </div>
                        </div>
                    </div>

                    <div v-if="view === 'users'" class="card p-0 overflow-hidden">
                        <table class="admin-table">
                            <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</th><th>‡∏Å‡∏≥‡∏´‡∏ô‡∏î Role</th><th>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô</th><th>Action</th></tr></thead>
                            <tbody>
                                <tr v-for="u in pendingUsers" :key="u.email">
                                    <td><div class="font-bold">{{ u.name }}</div><div class="text-xs">{{ u.email }}</div></td>
                                    <td>{{ u.department }} (Z{{ u.zone }})</td>
                                    <td><select v-model="u.tempRole" class="border rounded px-2 py-1"><option value="USER">User</option><option value="ADMIN">Admin</option></select></td>
                                    <td><input type="number" v-model="u.tempLimit" class="border rounded px-2 py-1 w-24" placeholder="0"></td>
                                    <td class="flex gap-2">
                                        <button @click="processUser(u, 'APPROVE')" class="bg-green-500 text-white px-3 py-1 rounded text-xs hover:bg-green-600">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                        <button @click="processUser(u, 'REJECT')" class="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                                    </td>
                                </tr>
                                <tr v-if="pendingUsers.length===0"><td colspan="5" class="text-center py-8">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div v-if="view === 'requests'" class="space-y-4">
                        <div class="card flex gap-4 p-4 items-center">
                            <i class="fas fa-filter text-gray-400"></i>
                            <select v-model="filters.zone" class="border p-2 rounded text-sm"><option value="">‡∏ó‡∏∏‡∏Å‡πÇ‡∏ã‡∏ô</option><option v-for="n in 15" :value="n">Zone {{n}}</option></select>
                            <select v-model="filters.status" class="border p-2 rounded text-sm"><option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option><option value="PENDING_HQ">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option><option value="APPROVED">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</option></select>
                            <input v-model="filters.search" class="border p-2 rounded text-sm flex-1" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠...">
                        </div>
                        <div class="card p-0 overflow-hidden">
                            <table class="admin-table">
                                <thead><tr><th>ID/‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th><th>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th><th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                                <tbody>
                                    <tr v-for="req in filteredRequests" :key="req.id" class="hover:bg-gray-50">
                                        <td><div class="font-bold text-blue-600">{{ req.id }}</div><div class="text-xs">{{ formatDate(req.date) }}</div></td>
                                        <td>{{ req.title }}</td>
                                        <td>{{ req.requester }} (Z{{ req.zone }})</td>
                                        <td class="font-mono">{{ formatMoney(req.amount) }}</td>
                                        <td><span :class="statusBadge(req.status)">{{ req.status }}</span></td>
                                        <td>
                                            <button @click="openDetail(req)" class="text-blue-600 hover:text-blue-800 font-bold text-xs border border-blue-200 px-3 py-1 rounded">
                                                ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div v-if="view === 'documents'" class="card">
                        <h3 class="font-bold mb-4">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (Archive)</h3>
                        <table class="admin-table">
                            <thead><tr><th>ID</th><th>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
                            <tbody>
                                <tr v-for="req in allRequests" :key="req.id">
                                    <td>{{ req.id }}</td>
                                    <td>
                                        <button v-if="req.fileId" @click="previewFile(req.fileId)" class="text-blue-500 hover:underline"><i class="fas fa-paperclip"></i> ‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå</button>
                                        <span v-else class="text-gray-300">-</span>
                                    </td>
                                    <td>{{ req.status }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div v-if="view === 'export'" class="grid grid-cols-3 gap-6">
                        <div @click="downloadCSV('users')" class="card text-center cursor-pointer hover:shadow-md border border-blue-200">
                            <i class="fas fa-users text-4xl text-blue-500 mb-2"></i>
                            <h3 class="font-bold">Export Users</h3>
                        </div>
                        <div @click="downloadCSV('requests')" class="card text-center cursor-pointer hover:shadow-md border border-green-200">
                            <i class="fas fa-file-invoice-dollar text-4xl text-green-500 mb-2"></i>
                            <h3 class="font-bold">Export Requests</h3>
                        </div>
                        <div @click="downloadCSV('logs')" class="card text-center cursor-pointer hover:shadow-md border border-gray-200">
                            <i class="fas fa-history text-4xl text-gray-500 mb-2"></i>
                            <h3 class="font-bold">Export Logs</h3>
                        </div>
                    </div>

                    <div v-if="view === 'logs'" class="card bg-gray-900 text-green-400 font-mono text-xs h-full overflow-auto">
                        <p>>> SYSTEM LOGS (Check Google Sheet 'Logs' for full history)...</p>
                        <p class="mt-2 text-gray-500">Feature to display live logs here requires simpler data structure, please use Export function for full audit.</p>
                    </div>

                </div>
            </div>
        </main>

        <div v-if="selectedReq" class="fixed inset-0 bg-black/70 z-50 flex justify-end">
            <div class="bg-white w-full max-w-2xl h-full shadow-2xl flex flex-col animate-[slideIn_0.3s]">
                <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                    <div>
                        <h3 class="text-xl font-bold">{{ selectedReq.title }}</h3>
                        <p class="text-sm text-gray-500">{{ selectedReq.id }} | {{ formatDate(selectedReq.date) }}</p>
                    </div>
                    <button @click="selectedReq=null"><i class="fas fa-times text-2xl text-gray-400"></i></button>
                </div>
                
                <div class="flex-1 overflow-y-auto p-6 space-y-6">
                    <div class="bg-blue-50 p-4 rounded border border-blue-100 grid grid-cols-2 gap-4">
                        <div><p class="label">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</p><p class="font-bold">{{ selectedReq.requester }}</p></div>
                        <div class="text-right"><p class="label">‡∏á‡∏ö‡∏ó‡∏µ‡πà‡∏Ç‡∏≠</p><p class="text-xl font-bold text-blue-600 font-mono">{{ formatMoney(selectedReq.amount) }}</p></div>
                        <div class="col-span-2 text-sm text-gray-600">
                            ‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î: {{ selectedReq.dept }} (Zone {{ selectedReq.zone }})<br>
                            User Limit Check: <span class="text-green-600 font-bold">Pass</span> (Simulated)
                        </div>
                    </div>

                    <div>
                        <p class="label mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
                        <div class="p-4 bg-gray-100 rounded text-sm">{{ selectedReq.desc }}</div>
                    </div>

                    <div>
                        <p class="label mb-2">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</p>
                        <button v-if="selectedReq.fileId" @click="previewFile(selectedReq.fileId)" class="btn bg-white border border-gray-300 text-gray-700 hover:bg-gray-50">
                            <i class="fas fa-eye mr-2"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                        </button>
                        <p v-else class="text-gray-400 text-sm">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ -</p>
                    </div>

                    <div v-if="selectedReq.status === 'PENDING_HQ'" class="border-t pt-6">
                        <p class="label mb-2 text-red-500 font-bold">* ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</p>
                        
                        <label class="text-sm text-gray-600">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Note)</label>
                        <textarea v-model="adminNote" class="w-full border p-2 rounded mb-4 text-sm" rows="2"></textarea>
                        
                        <label class="text-sm text-gray-600">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡∏≥‡∏Å‡∏±‡∏ö (Signature)</label>
                        <div class="border-2 border-dashed border-gray-300 rounded mb-4 relative bg-gray-50">
                            <canvas ref="sigCanvas" width="500" height="150" class="w-full h-32 cursor-crosshair"></canvas>
                            <div class="absolute bottom-2 right-2 text-xs text-red-400 cursor-pointer" @click="clearSig">‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <button @click="processReq('REJECTED')" class="btn bg-red-100 text-red-600 hover:bg-red-200 font-bold">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / ‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö</button>
                            <button @click="processReq('APPROVED')" class="btn bg-green-600 text-white hover:bg-green-700 font-bold shadow-lg">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠ (Approve)</button>
                        </div>
                    </div>

                    <div v-else class="bg-gray-50 p-4 rounded text-center">
                        <p class="font-bold text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: {{ selectedReq.status }}</p>
                        <p class="text-sm text-gray-500">Note: {{ selectedReq.adminNote || '-' }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="previewUrl" class="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4" @click.self="previewUrl=null">
            <div class="bg-white w-full max-w-5xl h-[90vh] rounded-lg flex flex-col overflow-hidden">
                <div class="p-3 bg-gray-100 border-b flex justify-between">
                    <h3 class="font-bold">Preview</h3>
                    <button @click="previewUrl=null"><i class="fas fa-times"></i></button>
                </div>
                <div class="flex-1 bg-gray-200">
                    <iframe :src="previewUrl" class="w-full h-full" border="0"></iframe>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, nextTick } = Vue;
        
        // üî¥üî¥üî¥ ‡πÉ‡∏™‡πà URL WEB APP ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ üî¥üî¥üî¥
        const API_URL = "https://script.google.com/macros/s/AKfycbye3C2LTDWD7MU162w-89ch5zX3KBRCVcIYM8uJDcuDrCf_FJWRRRLP04UnRtsOjWLE/exec"; 

        createApp({
            setup() {
                // State
                const isLoading = ref(false);
                const user = ref(null);
                const view = ref('dashboard');
                const loginForm = ref({email:'', password:''});
                
                // Data Store
                const stats = ref({ totalUsers:0, pendingUserCount:0, pendingReqCount:0, activeUserCount:0 });
                const pendingUsers = ref([]);
                const allRequests = ref([]);
                const filters = ref({ zone:'', status:'', search:'' });
                
                // Modals
                const selectedReq = ref(null);
                const adminNote = ref('');
                const sigCanvas = ref(null);
                const previewUrl = ref(null);
                let ctx = null, isDrawing = false;

                // --- API Core ---
                const callApi = async (payload) => {
                    if(!API_URL || API_URL.includes("URL_APPS_SCRIPT")) {
                        Swal.fire('Config Error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API URL ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô', 'error');
                        return;
                    }
                    isLoading.value = true;
                    try {
                        const res = await fetch(API_URL, { method:'POST', body:JSON.stringify(payload) });
                        return await res.json();
                    } catch(e) { console.error(e); return null; }
                    finally { isLoading.value = false; }
                };

                // --- Auth ---
                const handleLogin = async () => {
                    const res = await callApi({ action:'login', ...loginForm.value });
                    if(res?.status === 'success') {
                        user.value = res.user;
                        refreshData();
                    } else Swal.fire('Error', res?.message, 'error');
                };
                const logout = () => window.location.reload();

                // --- Data ---
                const refreshData = async () => {
                    const res = await callApi({ action:'getDashboard' });
                    if(res?.status === 'success') {
                        stats.value = res.data.stats;
                        pendingUsers.value = res.data.pendingUsers.map(u => ({...u, tempRole:'USER', tempLimit:0}));
                        allRequests.value = res.data.allRequests;
                    }
                };

                // --- Actions ---
                const processUser = async (u, type) => {
                    const res = await callApi({ 
                        action:'approveUser', targetEmail:u.email, actionType:type,
                        role:u.tempRole, limit:u.tempLimit, adminEmail:user.value.email 
                    });
                    if(res?.status === 'success') {
                        Swal.fire('Success', '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                        refreshData();
                    }
                };

                const openDetail = (req) => {
                    selectedReq.value = req;
                    adminNote.value = '';
                    if(req.status === 'PENDING_HQ') nextTick(initCanvas);
                };

                const processReq = async (status) => {
                    if(status === 'APPROVED' && isCanvasBlank()) return Swal.fire('Alert', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏Å‡∏±‡∏ö', 'warning');
                    
                    const signature = sigCanvas.value ? sigCanvas.value.toDataURL() : '';
                    const res = await callApi({
                        action:'processRequest', reqId:selectedReq.value.id, status,
                        note:adminNote.value, signature, adminEmail:user.value.email
                    });
                    
                    if(res?.status === 'success') {
                        Swal.fire('Success', '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                        selectedReq.value = null;
                        refreshData();
                    }
                };

                const downloadCSV = async (type) => {
                    const res = await callApi({ action:'exportData', type, adminEmail:user.value.email });
                    if(res?.status === 'success') {
                        let csv = "data:text/csv;charset=utf-8," + res.data.map(e => e.join(",")).join("\n");
                        let link = document.createElement("a");
                        link.href = encodeURI(csv);
                        link.download = `export_${type}.csv`;
                        link.click();
                    }
                };

                // --- Files & Canvas ---
                const previewFile = (id) => previewUrl.value = `https://drive.google.com/file/d/${id}/preview`;
                
                const initCanvas = () => {
                    const c = sigCanvas.value;
                    if(!c) return;
                    ctx = c.getContext('2d');
                    ctx.strokeStyle="#000"; ctx.lineWidth=2;
                    c.addEventListener('mousedown', startD); c.addEventListener('mouseup', endD); c.addEventListener('mousemove', drawD);
                    c.addEventListener('touchstart', (e)=>{e.preventDefault();startD(e.touches[0])}); 
                    c.addEventListener('touchend', endD); 
                    c.addEventListener('touchmove', (e)=>{e.preventDefault();drawD(e.touches[0])});
                };
                const startD = (e) => { isDrawing=true; drawD(e); };
                const endD = () => { isDrawing=false; ctx.beginPath(); };
                const drawD = (e) => {
                    if(!isDrawing) return;
                    const rect = sigCanvas.value.getBoundingClientRect();
                    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                    ctx.stroke(); ctx.beginPath(); ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
                };
                const clearSig = () => ctx.clearRect(0,0,sigCanvas.value.width,sigCanvas.value.height);
                const isCanvasBlank = () => !ctx.getImageData(0,0,500,150).data.some(c=>c!==0);

                // --- Helpers ---
                const pageTitle = computed(() => {
                    if(view.value==='dashboard') return 'Dashboard ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°';
                    if(view.value==='users') return '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£';
                    if(view.value==='requests') return '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
                    return view.value;
                });
                
                const filteredRequests = computed(() => allRequests.value.filter(r => 
                    (!filters.value.zone || r.zone == filters.value.zone) &&
                    (!filters.value.status || r.status == filters.value.status) &&
                    (!filters.value.search || r.requester.includes(filters.value.search))
                ));

                const formatMoney = (v) => new Intl.NumberFormat('th-TH', {style:'currency', currency:'THB'}).format(v);
                const formatDate = (d) => new Date(d).toLocaleDateString('th-TH');
                const statusBadge = (s) => ({'APPROVED':'bg-green-100 text-green-700','REJECTED':'bg-red-100 text-red-700','PENDING_HQ':'bg-orange-100 text-orange-700'}[s]||'bg-gray-100') + ' px-2 py-1 rounded text-xs font-bold';

                return {
                    isLoading, user, view, loginForm, stats, pendingUsers, filters, filteredRequests, allRequests,
                    handleLogin, logout, refreshData, processUser, 
                    selectedReq, openDetail, adminNote, sigCanvas, clearSig, processReq,
                    previewUrl, previewFile, downloadCSV,
                    pageTitle, formatMoney, formatDate, statusBadge
                };
            }
        }).mount('#app');
    </script>
    <style>.label { @apply text-xs font-bold text-gray-500 uppercase; }</style>
</body>
</html>
