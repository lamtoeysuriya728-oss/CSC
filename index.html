<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin HQ - ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏•‡∏≤‡∏á</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; }
        
        /* Sidebar Active State */
        .nav-item.active { background-color: #1f2937; color: #fff; border-right: 4px solid #3b82f6; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* Signature Canvas */
        canvas { touch-action: none; background: white; cursor: crosshair; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="app" class="h-screen w-full flex flex-col overflow-hidden text-gray-800">

    <div v-if="loading" class="fixed inset-0 bg-black/70 z-[999] flex flex-col items-center justify-center text-white backdrop-blur-sm">
        <i class="fas fa-circle-notch fa-spin text-5xl mb-4 text-blue-500"></i>
        <p class="text-xl animate-pulse">{{ loadingText }}</p>
    </div>

    <div v-if="!user" class="flex-1 flex items-center justify-center bg-gray-900 p-4" 
         style="background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://images.unsplash.com/photo-1497366216548-37526070297c?auto=format'); background-size: cover;">
        
        <div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-2xl fade-in">
            <div class="text-center mb-8">
                <div class="inline-block p-4 rounded-full bg-blue-50 text-blue-600 mb-4 text-3xl shadow-sm">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Admin Console (HQ)</h1>
                <p class="text-gray-500 text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
            </div>

            <form @submit.prevent="login">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</label>
                    <input v-model="loginForm.email" type="email" class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="admin@demo.com" required>
                </div>
                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input v-model="loginForm.password" type="password" class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow-lg">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </form>
            <p class="text-xs text-center text-gray-400 mt-4">* ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö HQ ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
        </div>
    </div>

    <div v-else class="flex flex-1 overflow-hidden fade-in">
        
        <aside class="w-64 bg-gray-900 text-gray-400 flex flex-col shadow-xl z-20">
            <div class="h-16 flex items-center px-6 border-b border-gray-800 bg-gray-900">
                <span class="text-white font-bold text-lg"><i class="fas fa-chart-network text-blue-500 mr-2"></i> Admin HQ</span>
            </div>

            <div class="flex-1 overflow-y-auto py-4">
                <p class="px-6 text-xs font-bold uppercase mb-2 mt-2">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</p>
                <div @click="setPage('dashboard')" :class="['nav-item px-6 py-3 cursor-pointer hover:bg-gray-800 hover:text-white transition', page==='dashboard'?'active':'']">
                    <i class="fas fa-home w-6"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
                </div>

                <p class="px-6 text-xs font-bold uppercase mb-2 mt-6">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</p>
                <div @click="setPage('users')" :class="['nav-item px-6 py-3 cursor-pointer hover:bg-gray-800 hover:text-white transition', page==='users'?'active':'']">
                    <div class="flex justify-between items-center">
                        <span><i class="fas fa-users-cog w-6"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</span>
                        <span v-if="stats.pendingUserCount > 0" class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">{{ stats.pendingUserCount }}</span>
                    </div>
                </div>
                <div @click="setPage('requests')" :class="['nav-item px-6 py-3 cursor-pointer hover:bg-gray-800 hover:text-white transition', page==='requests'?'active':'']">
                    <div class="flex justify-between items-center">
                        <span><i class="fas fa-file-invoice w-6"></i> ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏ö</span>
                        <span v-if="stats.pendingReqCount > 0" class="bg-orange-500 text-white text-xs px-2 py-0.5 rounded-full">{{ stats.pendingReqCount }}</span>
                    </div>
                </div>
                <div @click="setPage('documents')" :class="['nav-item px-6 py-3 cursor-pointer hover:bg-gray-800 hover:text-white transition', page==='documents'?'active':'']">
                    <i class="fas fa-folder w-6"></i> ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </div>

                <p class="px-6 text-xs font-bold uppercase mb-2 mt-6">‡∏£‡∏∞‡∏ö‡∏ö</p>
                <div @click="setPage('export')" :class="['nav-item px-6 py-3 cursor-pointer hover:bg-gray-800 hover:text-white transition', page==='export'?'active':'']">
                    <i class="fas fa-file-export w-6"></i> Export / ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                </div>
                <div @click="setPage('logs')" :class="['nav-item px-6 py-3 cursor-pointer hover:bg-gray-800 hover:text-white transition', page==='logs'?'active':'']">
                    <i class="fas fa-shield-alt w-6"></i> Audit Logs
                </div>
            </div>

            <div class="p-4 bg-gray-800 border-t border-gray-700">
                <button @click="logout" class="flex items-center text-red-400 hover:text-white transition">
                    <i class="fas fa-sign-out-alt mr-2"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-gray-100 relative">
            
            <header class="bg-white h-16 shadow-sm flex justify-between items-center px-8 z-10">
                <h2 class="text-xl font-bold text-gray-700 capitalize">{{ getPageTitle() }}</h2>
                <div class="flex items-center gap-3">
                    <div class="text-right hidden md:block">
                        <p class="text-sm font-bold text-gray-800">{{ user.name }}</p>
                        <p class="text-xs text-blue-600 font-bold uppercase">{{ user.role }}</p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 text-white flex items-center justify-center font-bold">
                        {{ user.name.charAt(0) }}
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-auto p-8">

                <div v-if="page === 'dashboard'" class="space-y-6">
                    <div class="flex justify-end">
                        <button @click="fetchData" class="text-sm text-blue-600 hover:underline"><i class="fas fa-sync"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-blue-500">
                            <p class="text-xs text-gray-500 font-bold uppercase">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                            <p class="text-3xl font-bold text-gray-800 mt-2">{{ stats.totalUsers }}</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-yellow-500">
                            <p class="text-xs text-gray-500 font-bold uppercase">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</p>
                            <p class="text-3xl font-bold text-gray-800 mt-2">{{ stats.pendingUserCount }}</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-orange-500">
                            <p class="text-xs text-gray-500 font-bold uppercase">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
                            <p class="text-3xl font-bold text-gray-800 mt-2">{{ stats.pendingReqCount }}</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-green-500">
                            <p class="text-xs text-gray-500 font-bold uppercase">‡πÇ‡∏ã‡∏ô‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï</p>
                            <p class="text-3xl font-bold text-gray-800 mt-2">Zone {{ stats.maxZone }}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-gray-800 text-white p-6 rounded-lg shadow-md">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs text-gray-400 font-bold uppercase">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</p>
                                    <p class="text-2xl font-bold text-green-400 mt-2">{{ formatCurrency(stats.totalBudgetVal) }}</p>
                                </div>
                                <i class="fas fa-university text-3xl text-gray-600"></i>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <p class="text-xs text-gray-500 font-bold uppercase">‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</p>
                            <p class="text-2xl font-bold text-red-500 mt-2">{{ formatCurrency(stats.usedBudgetVal) }}</p>
                            <div class="w-full bg-gray-200 h-1.5 rounded-full mt-2">
                                <div class="bg-red-500 h-1.5 rounded-full" :style="'width:' + (stats.usedBudgetVal/stats.totalBudgetVal)*100 + '%'"></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <p class="text-xs text-gray-500 font-bold uppercase">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
                            <p class="text-2xl font-bold text-blue-500 mt-2">{{ formatCurrency(stats.remainingBudgetVal) }}</p>
                        </div>
                    </div>
                </div>

                <div v-if="page === 'users'" class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <th class="px-6 py-3">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th class="px-6 py-3">‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</th>
                                <th class="px-6 py-3">‡∏Å‡∏≥‡∏´‡∏ô‡∏î Role</th>
                                <th class="px-6 py-3">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô</th>
                                <th class="px-6 py-3 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="u in pendingUsers" :key="u.email" class="bg-white border-b hover:bg-gray-50">
                                <td class="px-6 py-4 font-medium text-gray-900">
                                    {{ u.name }}<br>
                                    <span class="text-xs text-gray-400 font-normal">{{ u.email }}</span>
                                </td>
                                <td class="px-6 py-4">{{ u.department }} (Z{{ u.zone }})</td>
                                <td class="px-6 py-4">
                                    <select v-model="u.tempRole" class="border rounded px-2 py-1 bg-white">
                                        <option value="USER">User</option>
                                        <option value="ADMIN">Admin</option>
                                    </select>
                                </td>
                                <td class="px-6 py-4">
                                    <input type="number" v-model="u.tempLimit" class="border rounded px-2 py-1 w-24 text-right" placeholder="0">
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <button @click="processUser(u, 'APPROVE')" class="bg-green-500 text-white px-3 py-1 rounded text-xs hover:bg-green-600 mr-2">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                    <button @click="processUser(u, 'REJECT')" class="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                                </td>
                            </tr>
                            <tr v-if="pendingUsers.length === 0">
                                <td colspan="5" class="px-6 py-8 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div v-if="page === 'requests'" class="space-y-4">
                    <div class="bg-white p-4 rounded-lg shadow-sm flex flex-wrap gap-4 items-center">
                        <span class="font-bold text-gray-500"><i class="fas fa-filter"></i> ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á:</span>
                        <select v-model="filters.zone" class="border rounded px-3 py-2 text-sm"><option value="">‡∏ó‡∏∏‡∏Å‡πÇ‡∏ã‡∏ô</option><option v-for="n in 15" :value="n">Zone {{ n }}</option></select>
                        <select v-model="filters.status" class="border rounded px-3 py-2 text-sm"><option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option><option value="PENDING_HQ">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option><option value="APPROVED">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</option></select>
                        <input v-model="filters.search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." class="border rounded px-3 py-2 text-sm flex-grow">
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3">ID / ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th class="px-6 py-3">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
                                    <th class="px-6 py-3">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th>
                                    <th class="px-6 py-3 text-right">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
                                    <th class="px-6 py-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th class="px-6 py-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="req in filteredRequests" :key="req.id" class="border-b hover:bg-gray-50">
                                    <td class="px-6 py-4">
                                        <span class="font-bold text-blue-600">{{ req.id }}</span><br>
                                        <span class="text-xs text-gray-400">{{ formatDate(req.date) }}</span>
                                    </td>
                                    <td class="px-6 py-4 font-medium text-gray-900">{{ req.title }}</td>
                                    <td class="px-6 py-4">{{ req.requester }} (Z{{ req.zone }})</td>
                                    <td class="px-6 py-4 text-right font-mono">{{ formatCurrency(req.amount) }}</td>
                                    <td class="px-6 py-4 text-center">
                                        <span :class="getStatusClass(req.status)">{{ req.status }}</span>
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        <button @click="openDetail(req)" class="text-blue-600 hover:text-blue-800 text-xs border border-blue-200 px-3 py-1 rounded bg-blue-50">
                                            ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div v-if="page === 'documents'" class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="font-bold mb-4">‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="bg-gray-100"><tr><th class="p-3">ID</th><th class="p-3">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</th><th class="p-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
                        <tbody>
                            <tr v-for="req in allRequests" :key="req.id" class="border-b">
                                <td class="p-3">{{ req.id }}</td>
                                <td class="p-3">
                                    <button v-if="req.fileId" @click="previewFile(req.fileId)" class="text-blue-600 hover:underline"><i class="fas fa-paperclip"></i> ‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå</button>
                                    <span v-else class="text-gray-300">-</span>
                                </td>
                                <td class="p-3">{{ req.status }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div v-if="page === 'export'" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div @click="downloadCSV('users')" class="bg-white p-8 rounded-lg shadow-sm text-center cursor-pointer border border-transparent hover:border-blue-500 transition">
                        <i class="fas fa-users text-4xl text-blue-500 mb-3"></i>
                        <h3 class="font-bold text-gray-700">Export Users</h3>
                    </div>
                    <div @click="downloadCSV('requests')" class="bg-white p-8 rounded-lg shadow-sm text-center cursor-pointer border border-transparent hover:border-green-500 transition">
                        <i class="fas fa-file-invoice-dollar text-4xl text-green-500 mb-3"></i>
                        <h3 class="font-bold text-gray-700">Export Requests</h3>
                    </div>
                    <div @click="downloadCSV('logs')" class="bg-white p-8 rounded-lg shadow-sm text-center cursor-pointer border border-transparent hover:border-gray-500 transition">
                        <i class="fas fa-history text-4xl text-gray-500 mb-3"></i>
                        <h3 class="font-bold text-gray-700">Export Logs</h3>
                    </div>
                </div>

                <div v-if="page === 'logs'" class="bg-gray-900 text-green-400 p-6 rounded-lg shadow-lg font-mono text-xs h-full overflow-auto">
                    <p class="border-b border-gray-700 pb-2 mb-2">>> SYSTEM AUDIT TRAIL</p>
                    <p class="text-gray-500">Log data is stored securely in the Google Sheet backend.</p>
                    <button @click="downloadCSV('logs')" class="mt-4 bg-gray-700 px-3 py-1 rounded text-white hover:bg-gray-600">Download Full CSV Log</button>
                </div>

            </div>
        </main>

    </div>

    <div v-if="selectedReq" class="fixed inset-0 bg-black/80 z-[60] flex justify-end">
        <div class="bg-white w-full max-w-2xl h-full shadow-2xl flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                <div>
                    <h3 class="text-xl font-bold text-gray-800">{{ selectedReq.title }}</h3>
                    <p class="text-sm text-gray-500">{{ selectedReq.id }} | {{ formatDate(selectedReq.date) }}</p>
                </div>
                <button @click="selectedReq = null" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-2xl"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <div class="grid grid-cols-2 gap-4 bg-blue-50 p-4 rounded border border-blue-100">
                    <div>
                        <p class="text-xs text-blue-500 font-bold uppercase">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</p>
                        <p class="font-bold">{{ selectedReq.requester }}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-blue-500 font-bold uppercase">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</p>
                        <p class="text-xl font-bold text-blue-600 font-mono">{{ formatCurrency(selectedReq.amount) }}</p>
                    </div>
                    <div class="col-span-2 text-sm text-gray-600 border-t border-blue-200 pt-2 mt-2">
                        {{ selectedReq.dept }} (Zone {{ selectedReq.zone }})
                    </div>
                </div>

                <div>
                    <p class="text-xs font-bold text-gray-500 uppercase mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
                    <div class="bg-gray-100 p-4 rounded text-sm text-gray-700">{{ selectedReq.desc }}</div>
                </div>

                <div>
                    <p class="text-xs font-bold text-gray-500 uppercase mb-2">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</p>
                    <button v-if="selectedReq.fileId" @click="previewFile(selectedReq.fileId)" class="px-4 py-2 border rounded text-blue-600 bg-white hover:bg-blue-50 text-sm font-bold flex items-center gap-2">
                        <i class="fas fa-eye"></i> ‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö
                    </button>
                    <p v-else class="text-gray-400 text-sm">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ -</p>
                </div>

                <div v-if="selectedReq.status === 'PENDING_HQ'" class="border-t pt-6">
                    <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fas fa-pen-nib text-blue-500"></i> ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h4>
                    
                    <label class="block text-sm text-gray-600 mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (Note)</label>
                    <textarea v-model="adminNote" class="w-full border rounded p-2 text-sm mb-4" rows="2"></textarea>
                    
                    <label class="block text-sm text-gray-600 mb-1">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
                    <div class="border-2 border-dashed border-gray-300 rounded mb-4 relative bg-gray-50">
                        <canvas ref="sigCanvas" width="500" height="150" class="w-full h-32"></canvas>
                        <div @click="clearSig" class="absolute bottom-2 right-2 text-xs text-red-500 cursor-pointer hover:underline">‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <button @click="processReq('REJECTED')" class="py-3 border border-red-200 text-red-600 font-bold rounded hover:bg-red-50">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / ‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö</button>
                        <button @click="processReq('APPROVED')" class="py-3 bg-green-600 text-white font-bold rounded hover:bg-green-700 shadow-lg">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="previewUrl" class="fixed inset-0 bg-black/90 z-[70] flex flex-col items-center justify-center p-4" @click.self="previewUrl=null">
        <div class="bg-white w-full max-w-5xl h-[85vh] rounded-lg overflow-hidden flex flex-col">
            <div class="p-3 bg-gray-100 flex justify-between items-center border-b">
                <h3 class="font-bold text-gray-700">Preview</h3>
                <button @click="previewUrl=null"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 bg-gray-200">
                <iframe :src="previewUrl" class="w-full h-full border-0"></iframe>
            </div>
        </div>
    </div>

</div>

<script>
// ============================================
// üî¥ ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á APPS SCRIPT ‡∏ó‡∏µ‡πà Deploy ‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
// ============================================
const API_URL = "URL_APPS_SCRIPT_‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"; 

const { createApp } = Vue;

createApp({
    data() {
        return {
            loading: false,
            loadingText: '',
            user: null,
            page: 'dashboard',
            loginForm: { email: '', password: '' },
            
            // Data
            stats: { totalUsers:0, pendingUserCount:0, pendingReqCount:0, activeUserCount:0, totalBudgetVal:0, usedBudgetVal:0, remainingBudgetVal:0, maxZone:'-' },
            pendingUsers: [],
            allRequests: [],
            filters: { zone:'', status:'', search:'' },
            
            // Modal States
            selectedReq: null,
            adminNote: '',
            previewUrl: null,
            
            // Canvas
            ctx: null,
            isDrawing: false
        }
    },
    computed: {
        filteredRequests() {
            return this.allRequests.filter(r => {
                const matchZone = !this.filters.zone || r.zone == this.filters.zone;
                const matchStatus = !this.filters.status || r.status == this.filters.status;
                const matchSearch = !this.filters.search || r.requester.toLowerCase().includes(this.filters.search.toLowerCase());
                return matchZone && matchStatus && matchSearch;
            });
        }
    },
    methods: {
        // --- API CALLER ---
        async callApi(payload) {
            if(!API_URL || API_URL.includes("URL_APPS_SCRIPT")) {
                Swal.fire('Config Error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Apps Script URL ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î HTML ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 450', 'error');
                return null;
            }
            this.loading = true;
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const data = await res.json();
                return data;
            } catch (e) {
                console.error(e);
                Swal.fire('Connection Failed', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ', 'error');
                return null;
            } finally {
                this.loading = false;
            }
        },

        // --- AUTH ---
        async login() {
            this.loadingText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...';
            const res = await this.callApi({ action: 'login', ...this.loginForm });
            if (res?.status === 'success') {
                if (res.user.role !== 'ADMIN') {
                    Swal.fire('Access Denied', '‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ADMIN ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'warning');
                    return;
                }
                this.user = res.user;
                this.fetchData();
            } else {
                Swal.fire('Login Failed', res?.message || 'Error', 'error');
            }
        },
        logout() {
            this.user = null;
            this.loginForm = { email: '', password: '' };
            this.page = 'dashboard';
        },

        // --- DATA ---
        async fetchData() {
            this.loadingText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            const res = await this.callApi({ action: 'getDashboard' });
            if (res?.status === 'success') {
                this.stats = res.data.stats;
                // Add temp fields for user editing
                this.pendingUsers = res.data.pendingUsers.map(u => ({ ...u, tempRole: 'USER', tempLimit: 0 }));
                this.allRequests = res.data.allRequests;
            }
        },

        // --- ACTIONS ---
        async processUser(u, type) {
            this.loadingText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...';
            const res = await this.callApi({ 
                action: 'approveUser', 
                targetEmail: u.email, 
                actionType: type,
                role: u.tempRole, 
                limit: u.tempLimit, 
                adminEmail: this.user.email 
            });
            if (res?.status === 'success') {
                Swal.fire('Success', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                this.fetchData();
            }
        },

        async processReq(status) {
            if (status === 'APPROVED' && this.isCanvasBlank()) {
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'warning');
                return;
            }
            this.loadingText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå...';
            const signature = this.$refs.sigCanvas ? this.$refs.sigCanvas.toDataURL() : '';
            
            const res = await this.callApi({
                action: 'processRequest',
                reqId: this.selectedReq.id,
                status: status,
                note: this.adminNote,
                signature: signature,
                adminEmail: this.user.email
            });

            if (res?.status === 'success') {
                Swal.fire('Success', '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', 'success');
                this.selectedReq = null;
                this.fetchData();
            }
        },

        async downloadCSV(type) {
            this.loadingText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå CSV...';
            const res = await this.callApi({ action: 'exportData', type: type, adminEmail: this.user.email });
            if (res?.status === 'success') {
                let csv = "data:text/csv;charset=utf-8," + res.data.map(e => e.join(",")).join("\n");
                let link = document.createElement("a");
                link.href = encodeURI(csv);
                link.download = `export_${type}_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            }
        },

        // --- UI HELPERS ---
        setPage(p) { this.page = p; },
        getPageTitle() {
            const map = { 'dashboard': '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°', 'users': '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£', 'requests': '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', 'documents': '‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£', 'export': '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'logs': 'Audit Logs' };
            return map[this.page] || this.page;
        },
        openDetail(req) {
            this.selectedReq = req;
            this.adminNote = '';
            if (req.status === 'PENDING_HQ') {
                // Wait for modal render then init canvas
                setTimeout(this.initCanvas, 100);
            }
        },
        previewFile(fileId) {
            this.previewUrl = `https://drive.google.com/file/d/${fileId}/preview`;
        },
        
        // --- UTILS ---
        formatCurrency(v) { return new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(v); },
        formatDate(d) { return new Date(d).toLocaleDateString('th-TH'); },
        getStatusClass(s) {
            if (s === 'APPROVED') return 'bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold';
            if (s === 'REJECTED') return 'bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold';
            return 'bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-bold';
        },

        // --- CANVAS SIGNATURE ---
        initCanvas() {
            const c = this.$refs.sigCanvas;
            if (!c) return;
            this.ctx = c.getContext('2d');
            this.ctx.strokeStyle = "#000";
            this.ctx.lineWidth = 2;
            this.isDrawing = false;

            // Mouse Events
            c.addEventListener('mousedown', this.startDraw);
            c.addEventListener('mouseup', this.endDraw);
            c.addEventListener('mousemove', this.draw);
            // Touch Events
            c.addEventListener('touchstart', (e) => { e.preventDefault(); this.startDraw(e.touches[0]); });
            c.addEventListener('touchend', this.endDraw);
            c.addEventListener('touchmove', (e) => { e.preventDefault(); this.draw(e.touches[0]); });
        },
        startDraw(e) {
            this.isDrawing = true;
            this.draw(e);
        },
        endDraw() {
            this.isDrawing = false;
            this.ctx.beginPath();
        },
        draw(e) {
            if (!this.isDrawing) return;
            const rect = this.$refs.sigCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            this.ctx.lineTo(x, y);
            this.ctx.stroke();
            this.ctx.beginPath();
            this.ctx.moveTo(x, y);
        },
        clearSig() {
            this.ctx.clearRect(0, 0, 500, 150);
        },
        isCanvasBlank() {
            const pixelBuffer = new Uint32Array(
                this.ctx.getImageData(0, 0, 500, 150).data.buffer
            );
            return !pixelBuffer.some(color => color !== 0);
        }
    }
}).mount('#app');
</script>
</body>
</html>
