<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบงบส่งเสริม (สนญ.)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: { 
                extend: { 
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] }, 
                    colors: { brand: { 50: '#f0f9ff', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' } } 
                } 
            }
        }
    </script>
    <style>body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }</style>
</head>
<body>

    <div id="app" class="h-screen w-full flex flex-col overflow-hidden text-slate-800">

        <div v-if="isLoading" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center text-white flex-col backdrop-blur-sm">
            <i class="fas fa-circle-notch fa-spin text-5xl mb-4 text-brand-500"></i>
            <p class="text-xl animate-pulse">{{ loadingText }}</p>
        </div>

        <div v-if="!user" class="flex-1 flex items-center justify-center bg-brand-900 bg-opacity-90 p-4" 
             style="background-image: url('https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?auto=format'); background-size: cover; background-blend-mode: multiply;">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-8">
                <div class="text-center mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">ระบบขออนุมัติงบส่งเสริม</h1>
                    <p class="text-gray-500">เข้าสู่ระบบเพื่อดำเนินการ</p>
                </div>
                <div class="flex bg-gray-100 p-1 rounded-lg mb-6">
                    <button @click="authMode='login'" :class="authMode==='login'?'bg-white shadow text-brand-600':''" class="flex-1 py-2 rounded font-semibold transition">เข้าสู่ระบบ</button>
                    <button @click="authMode='register'" :class="authMode==='register'?'bg-white shadow text-brand-600':''" class="flex-1 py-2 rounded font-semibold transition">สมัครใช้งาน</button>
                </div>

                <form v-if="authMode === 'login'" @submit.prevent="handleLogin" class="space-y-4">
                    <input v-model="loginForm.email" type="email" placeholder="อีเมล" required class="w-full px-4 py-3 border rounded-lg">
                    <input v-model="loginForm.password" type="password" placeholder="รหัสผ่าน" required class="w-full px-4 py-3 border rounded-lg">
                    <button type="submit" class="w-full bg-brand-600 text-white py-3 rounded-lg font-bold hover:bg-brand-700 shadow">เข้าสู่ระบบ</button>
                </form>

                <form v-else @submit.prevent="handleRegister" class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <input v-model="regForm.firstname" placeholder="ชื่อ" required class="px-3 py-2 border rounded-lg">
                        <input v-model="regForm.lastname" placeholder="นามสกุล" required class="px-3 py-2 border rounded-lg">
                    </div>
                    <input v-model="regForm.email" type="email" placeholder="อีเมล" required class="w-full px-3 py-2 border rounded-lg">
                    <input v-model="regForm.password" type="password" placeholder="รหัสผ่าน" required class="w-full px-3 py-2 border rounded-lg">
                    <div class="grid grid-cols-2 gap-3">
                        <select v-model="regForm.zone" required class="px-3 py-2 border rounded-lg bg-white">
                            <option value="" disabled selected>เลือกโซน</option>
                            <option v-for="n in 15" :key="n" :value="n">โซน {{ n }}</option>
                        </select>
                        <input v-model="regForm.branch" placeholder="สาขา" required class="px-3 py-2 border rounded-lg">
                    </div>
                    <input v-model="regForm.department" placeholder="ฝ่าย" required class="w-full px-3 py-2 border rounded-lg">
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700">ลงทะเบียน</button>
                </form>
            </div>
        </div>

        <div v-else class="flex flex-1 overflow-hidden">
            <aside class="w-64 bg-slate-900 text-slate-300 hidden md:flex flex-col shadow-xl z-20">
                <div class="p-6 border-b border-slate-700">
                    <h2 class="font-bold text-white truncate">{{ user.name }}</h2>
                    <p class="text-xs text-brand-400 mt-1 uppercase">{{ user.role }} | {{ user.department }}</p>
                </div>
                <nav class="flex-1 p-4 space-y-2">
                    <a @click="navigate('dashboard')" :class="currentView === 'dashboard' ? 'bg-brand-600 text-white' : 'hover:bg-slate-800'" class="flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer transition">
                        <i class="fas fa-home w-6 text-center"></i> หน้าหลัก
                    </a>
                    
                    <template v-if="user.role === 'USER'">
                        <a @click="navigate('create_request')" :class="currentView === 'create_request' ? 'bg-brand-600 text-white' : 'hover:bg-slate-800'" class="flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer transition">
                            <i class="fas fa-plus-circle w-6 text-center"></i> สร้างคำขอใหม่
                        </a>
                    </template>

                    <template v-if="user.role === 'ADMIN'">
                        <div class="text-xs uppercase text-slate-500 font-bold mt-4 mb-2 px-2">ส่วนผู้ดูแล</div>
                        </template>
                </nav>
                <div class="p-4 border-t border-slate-700">
                    <button @click="logout" class="flex items-center gap-3 text-red-400 hover:text-red-300 px-4 py-2 w-full"><i class="fas fa-sign-out-alt"></i> ออกจากระบบ</button>
                </div>
            </aside>

            <main class="flex-1 flex flex-col bg-slate-50 overflow-hidden">
                <header class="bg-white shadow-sm p-4 md:hidden flex justify-between items-center z-10">
                    <span class="font-bold text-brand-900">ระบบงบส่งเสริม</span>
                    <button @click="logout" class="text-red-500"><i class="fas fa-sign-out-alt"></i></button>
                </header>

                <div class="flex-1 overflow-auto p-4 md:p-8">
                    
                    <div v-if="currentView === 'dashboard'">
                        
                        <div v-if="user.role === 'ADMIN'">
                            <div class="flex justify-between items-center mb-6">
                                <h1 class="text-2xl font-bold">Admin Dashboard</h1>
                                <button @click="fetchAdminData" class="text-brand-600"><i class="fas fa-sync"></i> Refresh</button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-orange-400">
                                    <p class="text-gray-500">คำขอรออนุมัติ</p>
                                    <p class="text-3xl font-bold">{{ stats.pendingRequestCount }}</p>
                                </div>
                                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-400">
                                    <p class="text-gray-500">ผู้สมัครรออนุมัติ</p>
                                    <p class="text-3xl font-bold">{{ stats.pendingUserCount }}</p>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                                <div class="flex border-b">
                                    <button @click="activeTab='requests'" :class="activeTab==='requests'?'border-b-2 border-brand-600 text-brand-600 bg-blue-50':''" class="flex-1 py-3 font-bold">คำขออนุมัติ</button>
                                    <button @click="activeTab='users'" :class="activeTab==='users'?'border-b-2 border-brand-600 text-brand-600 bg-blue-50':''" class="flex-1 py-3 font-bold">ผู้ใช้รออนุมัติ</button>
                                </div>
                                
                                <div v-if="activeTab === 'requests'" class="p-4 overflow-x-auto">
                                    <table class="w-full text-left text-sm">
                                        <thead class="bg-gray-50 text-gray-500">
                                            <tr><th>วันที่</th><th>เรื่อง</th><th>ผู้ขอ</th><th>ยอดเงิน</th><th>สถานะ</th><th>จัดการ</th></tr>
                                        </thead>
                                        <tbody class="divide-y">
                                            <tr v-for="req in allRequests" :key="req.id">
                                                <td class="py-3 px-2">{{ formatDate(req.timestamp) }}</td>
                                                <td class="py-3 px-2 font-medium">{{ req.title }}</td>
                                                <td class="py-3 px-2">{{ req.requester }}</td>
                                                <td class="py-3 px-2 font-mono">{{ formatCurrency(req.amount) }}</td>
                                                <td class="py-3 px-2"><span :class="statusClass(req.status)" class="px-2 py-1 rounded text-xs font-bold">{{ req.status }}</span></td>
                                                <td class="py-3 px-2">
                                                    <button v-if="req.status === 'PENDING_HQ'" @click="processRequest(req, 'APPROVED')" class="text-green-600 mr-2"><i class="fas fa-check-circle"></i></button>
                                                    <button v-if="req.status === 'PENDING_HQ'" @click="processRequest(req, 'REJECTED')" class="text-red-600"><i class="fas fa-times-circle"></i></button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div v-if="activeTab === 'users'" class="p-4">
                                    <div v-for="u in pendingUsers" :key="u.email" class="flex justify-between items-center border-b py-3 last:border-0">
                                        <div><p class="font-bold">{{ u.name }}</p><p class="text-xs text-gray-500">{{ u.email }} | {{ u.department }}</p></div>
                                        <button @click="approveUser(u)" class="bg-green-100 text-green-700 px-3 py-1 rounded text-xs font-bold hover:bg-green-200">อนุมัติ</button>
                                    </div>
                                    <p v-if="pendingUsers.length===0" class="text-center text-gray-400 py-4">ไม่มีผู้ใช้รออนุมัติ</p>
                                </div>
                            </div>
                        </div>

                        <div v-else>
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h1 class="text-2xl font-bold text-gray-800">รายการคำขอของฉัน</h1>
                                    <p class="text-gray-500">ประวัติการขออนุมัติงบประมาณ</p>
                                </div>
                                <button @click="navigate('create_request')" class="bg-brand-600 text-white px-4 py-2 rounded-lg shadow hover:bg-brand-700 transition">
                                    <i class="fas fa-plus mr-1"></i> สร้างคำขอ
                                </button>
                            </div>

                            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left text-sm">
                                        <thead class="bg-gray-50 text-gray-500 border-b">
                                            <tr>
                                                <th class="p-4 font-semibold">ID / วันที่</th>
                                                <th class="p-4 font-semibold">หัวข้อ</th>
                                                <th class="p-4 font-semibold text-right">ยอดเงิน</th>
                                                <th class="p-4 font-semibold text-center">สถานะ</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-100">
                                            <tr v-for="req in myRequests" :key="req.id" class="hover:bg-gray-50 transition">
                                                <td class="p-4">
                                                    <div class="font-bold text-brand-600">{{ req.id }}</div>
                                                    <div class="text-xs text-gray-400">{{ formatDate(req.timestamp) }}</div>
                                                </td>
                                                <td class="p-4">
                                                    <div class="font-medium text-gray-800">{{ req.title }}</div>
                                                    <div class="text-xs text-gray-500 truncate w-48">{{ req.description }}</div>
                                                </td>
                                                <td class="p-4 text-right font-mono text-gray-700">{{ formatCurrency(req.amount) }}</td>
                                                <td class="p-4 text-center">
                                                    <span :class="statusClass(req.status)" class="px-3 py-1 rounded-full text-xs font-bold inline-block">{{ req.status }}</span>
                                                </td>
                                            </tr>
                                            <tr v-if="myRequests.length === 0">
                                                <td colspan="4" class="p-10 text-center text-gray-400">
                                                    <i class="fas fa-folder-open text-4xl mb-2 text-gray-200 block"></i>
                                                    ยังไม่มีประวัติคำขอ
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="currentView === 'create_request'" class="max-w-2xl mx-auto">
                        <div class="mb-4">
                            <button @click="navigate('dashboard')" class="text-gray-500 hover:text-brand-600 mb-2 block"><i class="fas fa-arrow-left"></i> ย้อนกลับ</button>
                            <h1 class="text-2xl font-bold text-gray-800">สร้างคำขออนุมัติงบใหม่</h1>
                        </div>

                        <form @submit.prevent="submitRequest" class="bg-white p-8 rounded-xl shadow-lg space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">หัวข้อ / โครงการ</label>
                                <input v-model="requestForm.title" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand-500 outline-none">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">งบประมาณที่ขอ (บาท)</label>
                                <input v-model="requestForm.amount" type="number" min="1" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand-500 outline-none font-mono">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">รายละเอียด / เหตุผลความจำเป็น</label>
                                <textarea v-model="requestForm.description" rows="4" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand-500 outline-none"></textarea>
                            </div>

                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center bg-gray-50">
                                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-500">แนบเอกสาร PDF (ถ้ามี)</p>
                                <p class="text-xs text-orange-500 mt-1">*เวอร์ชัน Demo ระบบจะบันทึกเพียงชื่อไฟล์เท่านั้น</p>
                                <input type="file" class="mt-2 text-sm text-gray-500">
                            </div>

                            <button type="submit" class="w-full bg-brand-600 text-white py-3 rounded-lg font-bold hover:bg-brand-700 shadow-lg transition transform active:scale-95">
                                <i class="fas fa-paper-plane mr-2"></i> ส่งคำขออนุมัติ
                            </button>
                        </form>
                    </div>

                </div>
            </main>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        // ==========================================
        //  URL เดิม
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbzIs04PqRHu0Il6Ag-KKy_JMYtiodjfTl6imHOipmWbMWBEeelpENMfpPjI8O6AaNg9/exec"; 

        createApp({
            setup() {
                const isLoading = ref(false);
                const loadingText = ref('');
                const user = ref(null);
                const authMode = ref('login');
                const currentView = ref('dashboard');
                const activeTab = ref('requests');

                // Data
                const pendingUsers = ref([]);
                const allRequests = ref([]); // For Admin
                const myRequests = ref([]);  // For User
                const stats = ref({ pendingRequestCount: 0, pendingUserCount: 0 });

                // Forms
                const loginForm = ref({ email: '', password: '' });
                const regForm = ref({ firstname: '', lastname: '', email: '', password: '', zone: '', branch: '', department: '' });
                const requestForm = ref({ title: '', amount: '', description: '' });

                // --- API Handler ---
                const callApi = async (payload) => {
                    isLoading.value = true;
                    try {
                        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                        return await res.json();
                    } catch (e) {
                        Swal.fire('Connection Error', 'Please check internet', 'error');
                        return null;
                    } finally {
                        isLoading.value = false;
                    }
                };

                // --- Auth ---
                const handleLogin = async () => {
                    loadingText.value = "Logging in...";
                    const res = await callApi({ action: 'login', ...loginForm.value });
                    if (res?.status === 'success') {
                        user.value = res;
                        if (res.role === 'ADMIN') fetchAdminData();
                        if (res.role === 'USER') fetchUserRequests();
                    } else {
                        Swal.fire('Error', res?.message, 'error');
                    }
                };

                const handleRegister = async () => {
                    loadingText.value = "Registering...";
                    const res = await callApi({ action: 'register', ...regForm.value });
                    if (res?.status === 'success') {
                        Swal.fire('Success', res.message, 'success');
                        authMode.value = 'login';
                    } else {
                        Swal.fire('Error', res?.message, 'error');
                    }
                };

                const logout = () => {
                    user.value = null;
                    loginForm.value = { email: '', password: '' };
                    currentView.value = 'dashboard';
                };

                // --- Request Management ---
                const submitRequest = async () => {
                    loadingText.value = "Sending Request...";
                    const payload = {
                        action: 'createRequest',
                        ...requestForm.value,
                        requesterName: user.value.name,
                        requesterEmail: user.value.email,
                        department: user.value.department,
                        zone: user.value.zone
                    };
                    const res = await callApi(payload);
                    if (res?.status === 'success') {
                        Swal.fire('Success', 'ส่งคำขออนุมัติเรียบร้อย', 'success');
                        requestForm.value = { title: '', amount: '', description: '' };
                        navigate('dashboard'); // กลับไปหน้าหลักเพื่อดูรายการ
                    }
                };

                const fetchUserRequests = async () => {
                    loadingText.value = "Loading my requests...";
                    const res = await callApi({ action: 'getUserRequests', email: user.value.email });
                    if (res?.status === 'success') myRequests.value = res.data;
                };

                // --- Admin Actions ---
                const fetchAdminData = async () => {
                    loadingText.value = "Fetching Admin Data...";
                    const res = await callApi({ action: 'getAdminData' });
                    if (res?.status === 'success') {
                        pendingUsers.value = res.data.pendingUsers;
                        allRequests.value = res.data.allRequests;
                        stats.value = res.data.stats;
                    }
                };

                const processRequest = async (req, status) => {
                    loadingText.value = "Processing...";
                    const res = await callApi({ action: 'processRequest', reqId: req.id, status });
                    if (res?.status === 'success') fetchAdminData();
                };
                
                const approveUser = async (u) => {
                    loadingText.value = "Approving...";
                    const res = await callApi({ action: 'approveUser', targetEmail: u.email });
                    if (res?.status === 'success') fetchAdminData();
                };

                // --- Utils ---
                const navigate = (view) => {
                    currentView.value = view;
                    if(view === 'dashboard' && user.value.role === 'USER') fetchUserRequests();
                };
                const formatDate = (d) => new Date(d).toLocaleDateString('th-TH');
                const formatCurrency = (v) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(v);
                const statusClass = (s) => {
                    if(s==='APPROVED') return 'bg-green-100 text-green-700';
                    if(s==='REJECTED') return 'bg-red-100 text-red-700';
                    return 'bg-orange-100 text-orange-700';
                }

                return {
                    isLoading, loadingText, user, authMode, currentView, activeTab,
                    loginForm, regForm, requestForm,
                    pendingUsers, allRequests, myRequests, stats,
                    handleLogin, handleRegister, logout, navigate,
                    submitRequest, processRequest, approveUser, fetchAdminData,
                    formatDate, formatCurrency, statusClass
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
