<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (All Roles)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .nav-item { @apply flex items-center px-6 py-3 text-gray-400 hover:bg-gray-800 hover:text-white cursor-pointer transition-colors border-l-4 border-transparent; }
        .nav-item.active { @apply bg-gray-800 text-white border-blue-500; }
        canvas { touch-action: none; background: white; cursor: crosshair; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="app" class="h-screen w-full flex flex-col overflow-hidden text-gray-800">

    <div v-if="loading" class="fixed inset-0 bg-black/70 z-[999] flex flex-col items-center justify-center text-white backdrop-blur-sm">
        <i class="fas fa-circle-notch fa-spin text-5xl mb-4 text-blue-500"></i>
        <p class="text-xl animate-pulse">{{ loadingText }}</p>
    </div>

    <div v-if="!user" class="flex-1 flex items-center justify-center bg-gray-900 p-4" 
         style="background-image: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?auto=format'); background-size: cover;">
        
        <div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-2xl fade-in">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</h1>
                <p class="text-gray-500 text-sm">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
            </div>

            <div class="flex bg-gray-100 p-1 rounded-lg mb-6">
                <button @click="authMode='login'" :class="['flex-1 py-2 text-sm font-bold rounded-md transition', authMode==='login'?'bg-white shadow text-blue-600':'text-gray-500']">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <button @click="authMode='register'" :class="['flex-1 py-2 text-sm font-bold rounded-md transition', authMode==='register'?'bg-white shadow text-blue-600':'text-gray-500']">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà</button>
            </div>

            <form v-if="authMode==='login'" @submit.prevent="login">
                <div class="mb-4">
                    <input v-model="loginForm.email" type="email" class="w-full border p-3 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" required>
                </div>
                <div class="mb-6">
                    <input v-model="loginForm.password" type="password" class="w-full border p-3 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 shadow-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>

            <form v-else @submit.prevent="register">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input v-model="regForm.firstname" placeholder="‡∏ä‡∏∑‡πà‡∏≠" class="border p-2 rounded" required>
                    <input v-model="regForm.lastname" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="border p-2 rounded" required>
                </div>
                <input v-model="regForm.email" type="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="border p-2 rounded w-full mb-3" required>
                <input v-model="regForm.password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="border p-2 rounded w-full mb-3" required>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <select v-model="regForm.zone" class="border p-2 rounded" required>
                        <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô</option>
                        <option v-for="n in 15" :key="n" :value="n">Zone {{n}}</option>
                    </select>
                    <input v-model="regForm.branch" placeholder="‡∏™‡∏≤‡∏Ç‡∏≤" class="border p-2 rounded" required>
                </div>
                <input v-model="regForm.department" placeholder="‡∏ù‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î" class="border p-2 rounded w-full mb-4" required>
                <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
            </form>
        </div>
    </div>

    <div v-else class="flex flex-1 overflow-hidden fade-in">
        
        <aside class="w-64 bg-gray-900 text-gray-400 flex flex-col shadow-xl z-20">
            <div class="h-16 flex items-center px-6 border-b border-gray-800 bg-gray-900 text-white font-bold">
                <i class="fas fa-layer-group text-blue-500 mr-3"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
            </div>

            <div class="flex-1 overflow-y-auto py-4">
                
                <div v-if="user.role === 'ADMIN'">
                    <p class="px-6 text-xs font-bold uppercase mb-2 text-blue-500">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)</p>
                    <div @click="setPage('dashboard')" :class="['nav-item', page==='dashboard'?'active':'']"><i class="fas fa-chart-pie w-6"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</div>
                    <div @click="setPage('users')" :class="['nav-item', page==='users'?'active':'']">
                        <i class="fas fa-users-cog w-6"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£
                        <span v-if="stats.pendingUserCount>0" class="ml-auto bg-red-500 text-white text-xs px-2 rounded-full">{{stats.pendingUserCount}}</span>
                    </div>
                    <div @click="setPage('admin_requests')" :class="['nav-item', page==='admin_requests'?'active':'']">
                        <i class="fas fa-tasks w-6"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠
                        <span v-if="stats.pendingReqCount>0" class="ml-auto bg-orange-500 text-white text-xs px-2 rounded-full">{{stats.pendingReqCount}}</span>
                    </div>
                    <div @click="setPage('documents')" :class="['nav-item', page==='documents'?'active':'']"><i class="fas fa-folder w-6"></i> ‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</div>
                    <div @click="setPage('logs')" :class="['nav-item', page==='logs'?'active':'']"><i class="fas fa-shield-alt w-6"></i> Audit Logs</div>
                </div>

                <div v-if="user.role === 'USER'">
                    <p class="px-6 text-xs font-bold uppercase mb-2 mt-4 text-green-500">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (User)</p>
                    <div @click="setPage('create_request')" :class="['nav-item', page==='create_request'?'active':'']"><i class="fas fa-plus-circle w-6"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà</div>
                    <div @click="setPage('my_requests')" :class="['nav-item', page==='my_requests'?'active':'']"><i class="fas fa-list-alt w-6"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>
                </div>

            </div>

            <div class="p-4 bg-gray-800 border-t border-gray-700">
                <button @click="logout" class="flex items-center text-red-400 hover:text-white transition">
                    <i class="fas fa-sign-out-alt mr-2"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-gray-100 relative">
            <header class="bg-white h-16 shadow-sm flex justify-between items-center px-8 z-10">
                <h2 class="text-xl font-bold text-gray-700 capitalize">{{ getPageTitle() }}</h2>
                <div class="flex items-center gap-3">
                    <div class="text-right hidden md:block">
                        <p class="text-sm font-bold text-gray-800">{{ user.name }}</p>
                        <p class="text-xs text-blue-600 font-bold uppercase">{{ user.role }} | Zone {{ user.zone }}</p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold border border-blue-200">
                        {{ user.name.charAt(0) }}
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-auto p-8">

                <div v-if="page === 'dashboard' && user.role === 'ADMIN'" class="space-y-6">
                    <div class="flex justify-end"><button @click="refreshData" class="text-blue-600 text-sm hover:underline"><i class="fas fa-sync"></i> Refresh</button></div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded shadow border-l-4 border-blue-500">
                            <p class="text-xs text-gray-500 uppercase font-bold">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                            <p class="text-3xl font-bold mt-2">{{ stats.totalUsers }}</p>
                        </div>
                        <div class="bg-white p-6 rounded shadow border-l-4 border-yellow-500">
                            <p class="text-xs text-gray-500 uppercase font-bold">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</p>
                            <p class="text-3xl font-bold mt-2">{{ stats.pendingUserCount }}</p>
                        </div>
                        <div class="bg-white p-6 rounded shadow border-l-4 border-orange-500">
                            <p class="text-xs text-gray-500 uppercase font-bold">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
                            <p class="text-3xl font-bold mt-2">{{ stats.pendingReqCount }}</p>
                        </div>
                        <div class="bg-white p-6 rounded shadow border-l-4 border-green-500">
                            <p class="text-xs text-gray-500 uppercase font-bold">‡∏á‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</p>
                            <p class="text-2xl font-bold mt-2 text-green-600">{{ formatCurrency(stats.usedBudgetVal) }}</p>
                        </div>
                    </div>
                </div>

                <div v-if="page === 'users' && user.role === 'ADMIN'" class="bg-white rounded shadow overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 uppercase text-xs text-gray-600"><tr><th class="p-4">‡∏ä‡∏∑‡πà‡∏≠</th><th class="p-4">‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</th><th class="p-4">Role</th><th class="p-4">Limit</th><th class="p-4">Action</th></tr></thead>
                        <tbody>
                            <tr v-for="u in pendingUsers" :key="u.email" class="border-b">
                                <td class="p-4 font-bold">{{ u.name }}<br><span class="text-xs text-gray-400 font-normal">{{ u.email }}</span></td>
                                <td class="p-4">{{ u.department }} (Z{{ u.zone }})</td>
                                <td class="p-4"><select v-model="u.tempRole" class="border p-1 rounded"><option value="USER">User</option><option value="ADMIN">Admin</option></select></td>
                                <td class="p-4"><input type="number" v-model="u.tempLimit" class="border p-1 rounded w-20" placeholder="0"></td>
                                <td class="p-4"><button @click="processUser(u)" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button></td>
                            </tr>
                            <tr v-if="pendingUsers.length===0"><td colspan="5" class="p-6 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</td></tr>
                        </tbody>
                    </table>
                </div>

                <div v-if="page === 'admin_requests' && user.role === 'ADMIN'" class="space-y-4">
                    <div class="bg-white p-4 rounded shadow flex gap-4">
                        <select v-model="filters.status" class="border p-2 rounded"><option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option><option value="PENDING_HQ">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option><option value="APPROVED">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</option></select>
                        <input v-model="filters.search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="border p-2 rounded flex-1">
                    </div>
                    <div class="bg-white rounded shadow overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100 uppercase text-xs"><tr><th class="p-4">ID</th><th class="p-4">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th><th class="p-4">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th><th class="p-4 text-right">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th><th class="p-4 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="p-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                            <tbody>
                                <tr v-for="req in filteredRequests" :key="req.id" class="border-b hover:bg-gray-50">
                                    <td class="p-4 font-bold text-blue-600">{{ req.id }}</td>
                                    <td class="p-4">{{ req.title }}</td>
                                    <td class="p-4">{{ req.requester }}</td>
                                    <td class="p-4 text-right font-mono">{{ formatCurrency(req.amount) }}</td>
                                    <td class="p-4 text-center"><span :class="getStatusClass(req.status)">{{ req.status }}</span></td>
                                    <td class="p-4"><button @click="openDetail(req)" class="text-blue-600 border border-blue-200 px-3 py-1 rounded hover:bg-blue-50">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div v-if="page === 'logs' && user.role === 'ADMIN'" class="bg-gray-800 text-green-400 p-6 rounded shadow font-mono text-xs">
                    <p>>> SYSTEM LOGS...</p>
                    <button @click="downloadCSV('logs')" class="mt-4 bg-gray-600 text-white px-3 py-1 rounded">Download CSV</button>
                </div>

                <div v-if="page === 'create_request' && user.role === 'USER'" class="max-w-2xl mx-auto bg-white p-8 rounded shadow">
                    <h2 class="text-xl font-bold mb-6">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏á‡∏ö</h2>
                    <form @submit.prevent="submitRequest" class="space-y-4">
                        <div><label class="font-bold text-sm text-gray-600">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label><input v-model="requestForm.title" class="w-full border p-2 rounded" required></div>
                        <div><label class="font-bold text-sm text-gray-600">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (‡∏ö‡∏≤‡∏ó)</label><input v-model="requestForm.amount" type="number" class="w-full border p-2 rounded" required></div>
                        <div><label class="font-bold text-sm text-gray-600">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><textarea v-model="requestForm.description" rows="3" class="w-full border p-2 rounded" required></textarea></div>
                        <div class="border-2 border-dashed p-6 text-center rounded bg-gray-50">
                            <p class="text-sm text-gray-500 mb-2">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå (PDF/‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)</p>
                            <input type="file" @change="handleFileUpload" class="text-sm">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
                    </form>
                </div>

                <div v-if="page === 'my_requests' && user.role === 'USER'" class="bg-white rounded shadow overflow-hidden">
                    <div class="p-4 border-b font-bold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 uppercase text-xs"><tr><th class="p-4">ID</th><th class="p-4">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th><th class="p-4 text-right">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th><th class="p-4 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
                        <tbody>
                            <tr v-for="req in myRequests" :key="req.id" class="border-b">
                                <td class="p-4 font-bold text-blue-600">{{ req.id }}</td>
                                <td class="p-4">{{ req.title }}</td>
                                <td class="p-4 text-right font-mono">{{ formatCurrency(req.amount) }}</td>
                                <td class="p-4 text-center"><span :class="getStatusClass(req.status)">{{ req.status }}</span></td>
                            </tr>
                            <tr v-if="myRequests.length===0"><td colspan="4" class="p-6 text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠</td></tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </main>
    </div>

    <div v-if="selectedReq" class="fixed inset-0 bg-black/80 z-50 flex justify-end">
        <div class="bg-white w-full max-w-xl h-full flex flex-col p-0">
            <div class="p-4 border-b flex justify-between bg-gray-50">
                <h3 class="font-bold">{{ selectedReq.title }}</h3>
                <button @click="selectedReq=null"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-1 overflow-auto p-6 space-y-4">
                <div class="bg-blue-50 p-4 rounded">
                    <p class="font-bold text-blue-800">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠: {{ selectedReq.requester }}</p>
                    <p class="text-sm">‡∏á‡∏ö: {{ formatCurrency(selectedReq.amount) }}</p>
                    <p class="text-sm mt-2 text-gray-600">{{ selectedReq.desc }}</p>
                </div>
                
                <div v-if="selectedReq.fileId">
                    <button @click="previewFile(selectedReq.fileId)" class="w-full border p-2 rounded text-blue-600 font-bold hover:bg-blue-50">
                        <i class="fas fa-eye mr-2"></i> ‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö
                    </button>
                </div>

                <div v-if="selectedReq.status === 'PENDING_HQ'" class="border-t pt-4">
                    <p class="font-bold mb-2 text-red-500">‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
                    <textarea v-model="adminNote" class="w-full border p-2 rounded mb-2 text-sm" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..."></textarea>
                    <div class="border rounded mb-2 bg-gray-50">
                        <canvas ref="sigCanvas" width="400" height="150" class="w-full cursor-crosshair"></canvas>
                        <div @click="clearSig" class="text-right text-xs text-red-500 p-1 cursor-pointer">‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button @click="processReq('REJECTED')" class="bg-red-100 text-red-600 py-2 rounded font-bold">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                        <button @click="processReq('APPROVED')" class="bg-green-600 text-white py-2 rounded font-bold">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="previewUrl" class="fixed inset-0 bg-black/95 z-[99] flex flex-col p-4">
        <div class="text-right mb-2"><button @click="previewUrl=null" class="text-white text-2xl"><i class="fas fa-times"></i></button></div>
        <div class="flex-1 bg-white rounded overflow-hidden">
            <iframe :src="previewUrl" class="w-full h-full border-0"></iframe>
        </div>
    </div>

</div>

<script>
// üî¥üî¥üî¥ ‡πÉ‡∏™‡πà URL APPS SCRIPT ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ üî¥üî¥üî¥
const API_URL = "https://script.google.com/macros/s/AKfycbyGT0nAmMjJeTa2Fr4GtS0lm04l6JdzhTEEUJAv6c6iaM2Vbz11izoocVtA8PPgwJgR/exec"; 

const { createApp } = Vue;

createApp({
    data() {
        return {
            loading: false,
            loadingText: '',
            authMode: 'login', // login | register
            user: null,
            page: 'dashboard',
            
            // Forms
            loginForm: { email: '', password: '' },
            regForm: { firstname:'', lastname:'', email:'', password:'', zone:'', branch:'', department:'' },
            requestForm: { title:'', amount:'', description:'', file:null },
            
            // Data
            stats: {},
            pendingUsers: [],
            allRequests: [],
            myRequests: [], // For User
            filters: { status: '', search: '' },
            
            // Modals
            selectedReq: null,
            adminNote: '',
            previewUrl: null,
            ctx: null, isDrawing: false
        }
    },
    computed: {
        filteredRequests() {
            if(!this.allRequests) return [];
            return this.allRequests.filter(r => {
                const matchStatus = !this.filters.status || r.status == this.filters.status;
                const matchSearch = !this.filters.search || r.requester.toLowerCase().includes(this.filters.search.toLowerCase());
                return matchStatus && matchSearch;
            });
        }
    },
    methods: {
        async callApi(payload) {
            if(!API_URL || API_URL.includes("URL_APPS_SCRIPT")) {
                Swal.fire('Config Error', '‡πÉ‡∏™‡πà URL Apps Script ‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 450 ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö', 'error');
                return null;
            }
            this.loading = true;
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                return await res.json();
            } catch(e) { 
                console.error(e); 
                Swal.fire('Error', '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', 'error'); 
                return null; 
            } finally { 
                this.loading = false; 
            }
        },

        // --- AUTH ---
        async login() {
            this.loadingText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
            const res = await this.callApi({ action: 'login', ...this.loginForm });
            if (res?.status === 'success') {
                this.user = res.user;
                if(this.user.role === 'ADMIN') {
                    this.page = 'dashboard';
                    this.fetchAdminData();
                } else {
                    this.page = 'create_request'; // User ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏•‡∏¢
                    this.fetchUserData();
                }
            } else Swal.fire('Login Failed', res?.message, 'error');
        },
        async register() {
            this.loadingText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£...';
            const res = await this.callApi({ action:'register', ...this.regForm });
            if(res?.status === 'success') {
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏£‡∏≠ Admin ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'success');
                this.authMode = 'login';
            } else Swal.fire('Error', res?.message, 'error');
        },
        logout() { this.user = null; this.loginForm={email:'',password:''}; },

        // --- DATA ---
        async fetchAdminData() {
            const res = await this.callApi({ action: 'getDashboard' });
            if (res?.status === 'success') {
                this.stats = res.data.stats;
                this.pendingUsers = res.data.pendingUsers.map(u => ({...u, tempRole:'USER', tempLimit:0}));
                this.allRequests = res.data.allRequests;
            }
        },
        async fetchUserData() {
            const res = await this.callApi({ action: 'getUserRequests', email: this.user.email });
            if (res?.status === 'success') this.myRequests = res.data;
        },
        async refreshData() {
            if(this.user.role === 'ADMIN') this.fetchAdminData();
            else this.fetchUserData();
        },

        // --- ACTIONS ---
        async submitRequest() {
            this.loadingText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠...';
            let fileData = null, fileName = null;
            if(this.requestForm.file) {
                fileData = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.readAsDataURL(this.requestForm.file);
                });
                fileName = this.requestForm.file.name;
            }
            const res = await this.callApi({
                action: 'createRequest', ...this.requestForm,
                requesterName: this.user.name, requesterEmail: this.user.email,
                department: this.user.department, zone: this.user.zone,
                fileData, fileName
            });
            if(res?.status === 'success') {
                Swal.fire('Success', '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß', 'success');
                this.requestForm = {title:'',amount:'',description:'',file:null};
                this.page = 'my_requests';
                this.fetchUserData();
            } else Swal.fire('Error', res?.message, 'error');
        },
        handleFileUpload(e) { this.requestForm.file = e.target.files[0]; },

        async processUser(u) {
            const res = await this.callApi({ action:'approveUser', targetEmail:u.email, role:u.tempRole, limit:u.tempLimit, adminEmail:this.user.email });
            if(res?.status === 'success') { Swal.fire('Saved', '', 'success'); this.fetchAdminData(); }
        },
        async processReq(status) {
            if(status==='APPROVED' && this.isCanvasBlank()) return Swal.fire('Alert','‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô','warning');
            const sig = this.$refs.sigCanvas ? this.$refs.sigCanvas.toDataURL() : '';
            const res = await this.callApi({ action:'processRequest', reqId:this.selectedReq.id, status, note:this.adminNote, signature:sig, adminEmail:this.user.email });
            if(res?.status==='success') { Swal.fire('Saved','','success'); this.selectedReq=null; this.fetchAdminData(); }
        },
        async downloadCSV(type) {
            const res = await this.callApi({ action:'exportData', type, adminEmail:this.user.email });
            if(res?.status==='success') {
                let link = document.createElement("a");
                link.href = encodeURI("data:text/csv;charset=utf-8," + res.data.map(e=>e.join(",")).join("\n"));
                link.download = `export_${type}.csv`; link.click();
            }
        },

        // --- UI UTILS ---
        setPage(p) { this.page = p; if(p==='dashboard'||p==='my_requests') this.refreshData(); },
        getPageTitle() { 
            const map = {'dashboard':'‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö','users':'‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£','admin_requests':'‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠','create_request':'‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà','my_requests':'‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô'};
            return map[this.page] || this.page;
        },
        openDetail(req) { 
            this.selectedReq = req; this.adminNote=''; 
            if(req.status==='PENDING_HQ') setTimeout(this.initCanvas, 200);
        },
        previewFile(id) { this.previewUrl = `https://drive.google.com/file/d/${id}/preview`; },
        formatCurrency(v) { return new Intl.NumberFormat('th-TH',{style:'currency',currency:'THB'}).format(v); },
        formatDate(d) { return new Date(d).toLocaleDateString('th-TH'); },
        getStatusClass(s) { 
            if(s==='APPROVED') return 'bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold';
            if(s==='REJECTED') return 'bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold';
            return 'bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-bold';
        },

        // --- CANVAS ---
        initCanvas() {
            const c = this.$refs.sigCanvas; if(!c) return;
            this.ctx = c.getContext('2d'); this.ctx.lineWidth=2; this.isDrawing=false;
            c.addEventListener('mousedown', this.startD); c.addEventListener('mouseup', this.endD); c.addEventListener('mousemove', this.drawD);
            c.addEventListener('touchstart', (e)=>{e.preventDefault();this.startD(e.touches[0])}); c.addEventListener('touchend', this.endD); c.addEventListener('touchmove', (e)=>{e.preventDefault();this.drawD(e.touches[0])});
        },
        startD(e) { this.isDrawing=true; this.drawD(e); },
        endD() { this.isDrawing=false; this.ctx.beginPath(); },
        drawD(e) {
            if(!this.isDrawing) return;
            const rect = this.$refs.sigCanvas.getBoundingClientRect();
            this.ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            this.ctx.stroke(); this.ctx.beginPath(); this.ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        },
        clearSig() { this.ctx.clearRect(0,0,400,150); },
        isCanvasBlank() { return !this.ctx.getImageData(0,0,400,150).data.some(c=>c!==0); }
    }
}).mount('#app');
</script>
</body>
</html>
