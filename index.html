<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (‡∏™‡∏ô‡∏ç.)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f3f4f6; }
        .sidebar-link { @apply flex items-center gap-3 px-6 py-3 text-gray-400 hover:bg-gray-800 hover:text-white cursor-pointer transition border-l-4 border-transparent; }
        .sidebar-link.active { @apply bg-gray-800 text-white border-blue-500; }
        canvas { touch-action: none; background: white; cursor: crosshair; }
    </style>
</head>
<body>

<div id="app" class="h-screen w-full flex overflow-hidden">

    <div v-if="!user" class="fixed inset-0 bg-gray-900 z-50 flex items-center justify-center p-4 bg-[url('https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?auto=format')] bg-cover bg-blend-multiply">
        <div class="bg-white w-full max-w-md p-8 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</h2>
            
            <div class="flex bg-gray-100 p-1 rounded-lg mb-6">
                <button @click="authMode='login'" :class="['flex-1 py-2 text-sm font-bold rounded', authMode==='login'?'bg-white shadow text-blue-600':'text-gray-500']">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <button @click="authMode='register'" :class="['flex-1 py-2 text-sm font-bold rounded', authMode==='register'?'bg-white shadow text-blue-600':'text-gray-500']">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà</button>
            </div>

            <form v-if="authMode==='login'" @submit.prevent="login" class="space-y-4">
                <input v-model="form.email" type="email" placeholder="Email" class="w-full border p-3 rounded" required>
                <input v-model="form.pass" type="password" placeholder="Password" class="w-full border p-3 rounded" required>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700">Login</button>
            </form>

            <form v-else @submit.prevent="register" class="space-y-3">
                <input v-model="reg.name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" class="w-full border p-2 rounded" required>
                <input v-model="reg.email" type="email" placeholder="Email" class="w-full border p-2 rounded" required>
                <input v-model="reg.password" type="password" placeholder="Password" class="w-full border p-2 rounded" required>
                <div class="grid grid-cols-2 gap-2">
                    <select v-model="reg.zone" class="border p-2 rounded" required>
                        <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô</option>
                        <option v-for="n in 15" :value="n">Zone {{n}}</option>
                    </select>
                    <input v-model="reg.branch" placeholder="‡∏™‡∏≤‡∏Ç‡∏≤" class="border p-2 rounded" required>
                </div>
                <input v-model="reg.dept" placeholder="‡∏ù‡πà‡∏≤‡∏¢" class="w-full border p-2 rounded" required>
                <button type="submit" class="w-full bg-green-600 text-white py-3 rounded font-bold hover:bg-green-700">Register</button>
            </form>
        </div>
    </div>

    <template v-else>
        <aside class="w-64 bg-gray-900 text-white flex flex-col shadow-xl">
            <div class="h-16 flex items-center px-6 font-bold text-lg border-b border-gray-800">
                <i class="fas fa-coins text-blue-500 mr-2"></i> Budget System
            </div>
            <div class="flex-1 py-4 overflow-y-auto">
                
                <template v-if="user.role === 'ADMIN'">
                    <p class="px-6 text-xs text-gray-500 font-bold uppercase mb-2">Admin Menu</p>
                    <a @click="setPage('dashboard')" :class="['sidebar-link', page==='dashboard'?'active':'']"><i class="fas fa-chart-pie w-5"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</a>
                    <a @click="setPage('users')" :class="['sidebar-link', page==='users'?'active':'']">
                        <i class="fas fa-users w-5"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£
                        <span v-if="stats.pendingUsers>0" class="ml-auto bg-red-500 text-xs px-2 rounded-full">{{stats.pendingUsers}}</span>
                    </a>
                    <a @click="setPage('requests')" :class="['sidebar-link', page==='requests'?'active':'']">
                        <i class="fas fa-list w-5"></i> ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        <span v-if="stats.pendingReq>0" class="ml-auto bg-orange-500 text-xs px-2 rounded-full">{{stats.pendingReq}}</span>
                    </a>
                    <a @click="setPage('logs')" :class="['sidebar-link', page==='logs'?'active':'']"><i class="fas fa-history w-5"></i> Audit Logs</a>
                    <a @click="setPage('export')" :class="['sidebar-link', page==='export'?'active':'']"><i class="fas fa-download w-5"></i> Export</a>
                </template>

                <template v-else>
                    <p class="px-6 text-xs text-gray-500 font-bold uppercase mb-2">User Menu</p>
                    <a @click="setPage('create')" :class="['sidebar-link', page==='create'?'active':'']"><i class="fas fa-plus w-5"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</a>
                    <a @click="setPage('my_requests')" :class="['sidebar-link', page==='my_requests'?'active':'']"><i class="fas fa-list-alt w-5"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a>
                </template>
            </div>
            <div class="p-4 bg-gray-800">
                <button @click="logout" class="flex items-center text-red-400 hover:text-white"><i class="fas fa-sign-out-alt mr-2"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden bg-gray-100">
            <header class="h-16 bg-white shadow-sm flex justify-between items-center px-8">
                <h2 class="font-bold text-xl text-gray-800">{{ pageName }}</h2>
                <div class="text-right">
                    <p class="font-bold text-sm">{{ user.name }}</p>
                    <p class="text-xs text-blue-600">{{ user.role }} | {{ user.dept }}</p>
                </div>
            </header>

            <div class="flex-1 overflow-auto p-8 relative">
                <div v-if="loading" class="absolute inset-0 bg-white/80 z-40 flex items-center justify-center flex-col">
                    <i class="fas fa-circle-notch fa-spin text-4xl text-blue-500"></i>
                    <p class="text-gray-500 mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
                </div>

                <div v-if="page==='dashboard'" class="space-y-6">
                    <div class="grid grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded shadow border-l-4 border-blue-500">
                            <p class="text-xs font-bold text-gray-500">USER ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                            <p class="text-3xl font-bold">{{ stats.totalUsers }}</p>
                        </div>
                        <div class="bg-white p-6 rounded shadow border-l-4 border-orange-500">
                            <p class="text-xs font-bold text-gray-500">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
                            <p class="text-3xl font-bold">{{ stats.pendingReq }}</p>
                        </div>
                        <div class="bg-white p-6 rounded shadow border-l-4 border-green-500">
                            <p class="text-xs font-bold text-gray-500">‡∏á‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</p>
                            <p class="text-2xl font-bold text-green-600">{{ currency(stats.usedBudget) }}</p>
                        </div>
                        <div class="bg-white p-6 rounded shadow border-l-4 border-gray-500">
                            <p class="text-xs font-bold text-gray-500">‡∏á‡∏ö‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
                            <p class="text-2xl font-bold text-blue-600">{{ currency(stats.remainBudget) }}</p>
                        </div>
                    </div>
                </div>

                <div v-if="page==='users'" class="bg-white rounded shadow overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 uppercase text-xs"><tr><th class="p-4">‡∏ä‡∏∑‡πà‡∏≠</th><th class="p-4">‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</th><th class="p-4">Role</th><th class="p-4">Limit</th><th class="p-4">Action</th></tr></thead>
                        <tbody>
                            <tr v-for="u in pendingUsers" :key="u.email" class="border-b">
                                <td class="p-4 font-bold">{{ u.name }}<br><span class="text-xs font-normal text-gray-400">{{ u.email }}</span></td>
                                <td class="p-4">{{ u.dept }} (Z{{ u.zone }})</td>
                                <td class="p-4"><select v-model="u.tempRole" class="border p-1 rounded"><option value="USER">User</option><option value="ADMIN">Admin</option></select></td>
                                <td class="p-4"><input type="number" v-model="u.tempLimit" class="border p-1 w-24 rounded" placeholder="0"></td>
                                <td class="p-4"><button @click="approveUser(u, true)" class="bg-green-500 text-white px-3 py-1 rounded text-xs mr-2">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button><button @click="approveUser(u, false)" class="bg-red-500 text-white px-3 py-1 rounded text-xs">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button></td>
                            </tr>
                            <tr v-if="pendingUsers.length===0"><td colspan="5" class="p-6 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>
                        </tbody>
                    </table>
                </div>

                <div v-if="page==='requests' || page==='my_requests'" class="space-y-4">
                    <div v-if="user.role==='ADMIN'" class="flex gap-4 mb-4">
                        <select v-model="filterStatus" class="border p-2 rounded"><option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option><option value="PENDING_HQ">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option><option value="APPROVED">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</option></select>
                        <input v-model="filterSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." class="border p-2 rounded flex-1">
                    </div>
                    <div class="bg-white rounded shadow overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100 uppercase text-xs"><tr><th class="p-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-4">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th><th class="p-4">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th><th class="p-4 text-right">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th><th class="p-4 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="p-4"></th></tr></thead>
                            <tbody>
                                <tr v-for="req in filteredReqs" :key="req.id" class="border-b hover:bg-gray-50">
                                    <td class="p-4 text-gray-500">{{ date(req.date) }}</td>
                                    <td class="p-4 font-bold text-gray-800">{{ req.title }}</td>
                                    <td class="p-4">{{ req.requester }}</td>
                                    <td class="p-4 text-right font-mono">{{ currency(req.amount) }}</td>
                                    <td class="p-4 text-center"><span :class="statusClass(req.status)">{{ req.status }}</span></td>
                                    <td class="p-4 text-center">
                                        <button @click="openDetail(req)" class="text-blue-600 border border-blue-200 px-3 py-1 rounded hover:bg-blue-50 text-xs">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div v-if="page==='create'" class="max-w-2xl mx-auto bg-white p-8 rounded shadow">
                    <h3 class="font-bold text-lg mb-4">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà</h3>
                    <form @submit.prevent="submitRequest" class="space-y-4">
                        <input v-model="newReq.title" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠" class="w-full border p-2 rounded" required>
                        <input v-model="newReq.amount" type="number" placeholder="‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì" class="w-full border p-2 rounded" required>
                        <textarea v-model="newReq.desc" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" class="w-full border p-2 rounded" rows="3" required></textarea>
                        <div class="border-2 border-dashed p-4 text-center">
                            <p class="text-sm text-gray-500 mb-2">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå (PDF/‡∏£‡∏π‡∏õ)</p>
                            <input type="file" @change="handleFile">
                        </div>
                        <button class="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
                    </form>
                </div>

                <div v-if="page==='export'" class="grid grid-cols-3 gap-6">
                    <div @click="doExport('users')" class="bg-white p-8 text-center rounded shadow cursor-pointer hover:border-blue-500 border border-transparent"><i class="fas fa-users text-4xl text-blue-500 mb-2"></i><br>Export Users</div>
                    <div @click="doExport('requests')" class="bg-white p-8 text-center rounded shadow cursor-pointer hover:border-green-500 border border-transparent"><i class="fas fa-file-invoice text-4xl text-green-500 mb-2"></i><br>Export Requests</div>
                    <div @click="doExport('logs')" class="bg-white p-8 text-center rounded shadow cursor-pointer hover:border-gray-500 border border-transparent"><i class="fas fa-history text-4xl text-gray-500 mb-2"></i><br>Export Logs</div>
                </div>
                
                <div v-if="page==='logs'" class="bg-gray-800 text-green-400 p-6 rounded font-mono text-xs">
                    <p>Audit Log System Active...</p>
                    <button @click="doExport('logs')" class="mt-4 bg-gray-600 text-white px-3 py-1 rounded">Download CSV</button>
                </div>

            </div>
        </main>
    </template>

    <div v-if="selectedReq" class="fixed inset-0 bg-black/80 z-50 flex justify-end">
        <div class="bg-white w-full max-w-xl h-full flex flex-col">
            <div class="p-4 border-b flex justify-between bg-gray-50">
                <h3 class="font-bold">{{ selectedReq.title }}</h3>
                <button @click="selectedReq=null"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-1 overflow-auto p-6 space-y-4">
                <div class="bg-blue-50 p-4 rounded border border-blue-100">
                    <p class="font-bold text-blue-800">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠: {{ selectedReq.requester }}</p>
                    <p class="text-sm">‡∏á‡∏ö: {{ currency(selectedReq.amount) }}</p>
                    <p class="text-sm mt-2 text-gray-600">{{ selectedReq.desc }}</p>
                </div>
                
                <div v-if="selectedReq.fileId">
                    <a :href="`https://drive.google.com/file/d/${selectedReq.fileId}/preview`" target="_blank" class="block w-full text-center border p-2 rounded text-blue-600 font-bold hover:bg-blue-50">
                        <i class="fas fa-eye mr-2"></i> ‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö
                    </a>
                </div>
                <div v-else class="text-center text-gray-400">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ -</div>

                <div v-if="user.role === 'ADMIN' && selectedReq.status === 'PENDING_HQ'" class="border-t pt-4">
                    <p class="font-bold mb-2 text-red-500">‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
                    <textarea v-model="adminNote" class="w-full border p-2 rounded mb-2 text-sm" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..."></textarea>
                    <div class="border rounded mb-2 bg-gray-50">
                        <canvas ref="sigCanvas" width="400" height="150" class="w-full cursor-crosshair"></canvas>
                        <div @click="clearSig" class="text-right text-xs text-red-500 p-1 cursor-pointer">‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button @click="processReq('REJECTED')" class="bg-red-100 text-red-600 py-2 rounded font-bold">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                        <button @click="processReq('APPROVED')" class="bg-green-600 text-white py-2 rounded font-bold">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                    </div>
                </div>
                
                <div v-if="selectedReq.status !== 'PENDING_HQ'" class="text-center p-4 bg-gray-100 rounded">
                    <p class="font-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: {{ selectedReq.status }}</p>
                    <p class="text-sm text-gray-500">Note: {{ selectedReq.note || '-' }}</p>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
// üî¥üî¥üî¥ ‡πÉ‡∏™‡πà URL APPS SCRIPT ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ üî¥üî¥üî¥
const API_URL = "URL_APPS_SCRIPT_‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì";

const { createApp } = Vue;

createApp({
    data() {
        return {
            loading: false, authMode: 'login',
            user: null, page: 'dashboard',
            loginForm: {email:'', password:''},
            reg: {name:'', email:'', password:'', zone:'', branch:'', dept:''},
            newReq: {title:'', amount:'', desc:'', file:null},
            stats: {}, pendingUsers: [], requests: [],
            filterStatus: '', filterSearch: '',
            selectedReq: null, adminNote: '',
            ctx: null, isDrawing: false
        }
    },
    computed: {
        pageName() {
            const map = {'dashboard':'‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°','users':'‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£','requests':'‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î','create':'‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠','my_requests':'‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô','export':'Export','logs':'Logs'};
            return map[this.page] || this.page;
        },
        filteredReqs() {
            return this.requests.filter(r => {
                const matchStatus = !this.filterStatus || r.status === this.filterStatus;
                const matchSearch = !this.filterSearch || r.requester.toLowerCase().includes(this.filterSearch.toLowerCase());
                return matchStatus && matchSearch;
            });
        }
    },
    methods: {
        async api(payload) {
            this.loading = true;
            try {
                const res = await fetch(API_URL, {method:'POST', body:JSON.stringify(payload)});
                return await res.json();
            } catch(e) { Swal.fire('Error','Connection Failed','error'); return null; }
            finally { this.loading = false; }
        },
        async login() {
            const res = await this.api({action:'login', ...this.loginForm});
            if(res?.status==='success') {
                this.user = res.user;
                this.page = this.user.role === 'ADMIN' ? 'dashboard' : 'my_requests';
                this.loadData();
            } else Swal.fire('Login Failed', res?.message, 'error');
        },
        async register() {
            const res = await this.api({action:'register', ...this.reg});
            if(res?.status==='success') { Swal.fire('Success','‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥','success'); this.authMode='login'; }
        },
        logout() { this.user = null; this.loginForm={}; },
        async loadData() {
            const res = await this.api({action:'getData', role:this.user.role, email:this.user.email});
            if(res?.status==='success') {
                this.stats = res.data.stats;
                this.pendingUsers = res.data.pendingUsers.map(u => ({...u, tempRole:'USER', tempLimit:0}));
                this.requests = res.data.requests;
            }
        },
        setPage(p) { this.page = p; this.loadData(); },
        
        // Actions
        async submitRequest() {
            let fileData = null, fileName = null;
            if(this.newReq.file) {
                fileData = await new Promise(r => { const rd = new FileReader(); rd.onload=e=>r(e.target.result); rd.readAsDataURL(this.newReq.file); });
                fileName = this.newReq.file.name;
            }
            const res = await this.api({
                action:'createRequest', ...this.newReq, 
                name:this.user.name, email:this.user.email, dept:this.user.dept, zone:this.user.zone, branch:this.user.branch,
                fileData, fileName, mimeType: this.newReq.file?.type
            });
            if(res?.status==='success') { Swal.fire('Success','‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß','success'); this.page='my_requests'; this.loadData(); }
        },
        handleFile(e) { this.newReq.file = e.target.files[0]; },
        
        async approveUser(u, isApprove) {
            const res = await this.api({action:'approveUser', targetEmail:u.email, isApprove, role:u.tempRole, limit:u.tempLimit, adminEmail:this.user.email});
            if(res?.status==='success') { Swal.fire('Saved','','success'); this.loadData(); }
        },
        
        openDetail(req) { this.selectedReq = req; if(req.status==='PENDING_HQ') setTimeout(this.initCanvas, 300); },
        async processReq(status) {
            if(status==='APPROVED' && this.isCanvasBlank()) return Swal.fire('Alert','‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô','warning');
            const sig = this.$refs.sigCanvas ? this.$refs.sigCanvas.toDataURL() : '';
            const res = await this.api({action:'processRequest', reqId:this.selectedReq.id, status, note:this.adminNote, signature:sig, adminEmail:this.user.email});
            if(res?.status==='success') { Swal.fire('Saved','','success'); this.selectedReq=null; this.loadData(); }
        },
        async doExport(type) {
            const res = await this.api({action:'export', type, adminEmail:this.user.email});
            if(res?.status==='success') {
                let link = document.createElement("a");
                link.href = encodeURI("data:text/csv;charset=utf-8," + res.data.map(e=>e.join(",")).join("\n"));
                link.download = `export_${type}.csv`; link.click();
            }
        },

        // Helpers
        currency(v) { return new Intl.NumberFormat('th-TH',{style:'currency',currency:'THB'}).format(v); },
        date(d) { return new Date(d).toLocaleDateString('th-TH'); },
        statusClass(s) { return ({'APPROVED':'bg-green-100 text-green-700','REJECTED':'bg-red-100 text-red-700'}[s]||'bg-orange-100 text-orange-700') + ' px-2 py-1 rounded text-xs font-bold'; },

        // Canvas
        initCanvas() {
            const c = this.$refs.sigCanvas; if(!c) return;
            this.ctx = c.getContext('2d'); this.ctx.lineWidth=2; this.isDrawing=false;
            c.addEventListener('mousedown',this.startD); c.addEventListener('mouseup',this.endD); c.addEventListener('mousemove',this.drawD);
            c.addEventListener('touchstart',(e)=>{e.preventDefault();this.startD(e.touches[0])}); c.addEventListener('touchend',this.endD); c.addEventListener('touchmove',(e)=>{e.preventDefault();this.drawD(e.touches[0])});
        },
        startD(e) { this.isDrawing=true; this.drawD(e); },
        endD() { this.isDrawing=false; this.ctx.beginPath(); },
        drawD(e) {
            if(!this.isDrawing) return;
            const r = this.$refs.sigCanvas.getBoundingClientRect();
            this.ctx.lineTo(e.clientX-r.left, e.clientY-r.top);
            this.ctx.stroke(); this.ctx.beginPath(); this.ctx.moveTo(e.clientX-r.left, e.clientY-r.top);
        },
        clearSig() { this.ctx.clearRect(0,0,500,150); },
        isCanvasBlank() { return !this.ctx.getImageData(0,0,500,150).data.some(c=>c!==0); }
    }
}).mount('#app');
</script>
</body>
</html>
